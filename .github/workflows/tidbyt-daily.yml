name: Tidbyt Daily Push

on:
  schedule:
    # 6 AM Central (UTC-6) = noon UTC
    - cron: '0 12 * * *'
  workflow_dispatch:

jobs:
  push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install Python dependencies
        run: uv sync

      - name: Install pixlet
        run: |
          PIXLET_TAG=$(gh release view --repo tidbyt/pixlet --json tagName -q .tagName)
          PIXLET_VER=${PIXLET_TAG#v}
          curl -LO "https://github.com/tidbyt/pixlet/releases/download/${PIXLET_TAG}/pixlet_${PIXLET_VER}_linux_amd64.tar.gz"
          tar -xzf "pixlet_${PIXLET_VER}_linux_amd64.tar.gz"
          sudo mv pixlet /usr/local/bin/
          pixlet version
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Write config
        run: |
          cat > config.yaml << 'EOF'
          stores:
            - slug: "mt-horeb"
              brand: "culvers"
              name: "Mt. Horeb"
              role: "primary"
            - slug: "madison-todd-drive"
              brand: "culvers"
              name: "Madison Todd Dr"
              role: "secondary"
          worker_base: "https://custard.chriskaschner.com"
          tidbyt:
            device_id: "${{ secrets.TIDBYT_DEVICE_ID }}"
            installation_id: "culvers"
            view_mode: "three_day"
            brand: "culvers"
          EOF

      - name: Fetch flavor data
        run: uv run python main.py --fetch-only

      - name: Render and push to Tidbyt
        env:
          TIDBYT_API_TOKEN: ${{ secrets.TIDBYT_API_TOKEN }}
        run: uv run python main.py --tidbyt-only
