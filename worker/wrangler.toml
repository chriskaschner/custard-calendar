name = "custard-calendar"
main = "src/index.js"
compatibility_date = "2024-09-23"

[vars]
ENVIRONMENT = "production"
# Legacy admin token fallback (deprecated).
# New admin protection uses ADMIN_ACCESS_TOKEN secret.
ACCESS_TOKEN = ""
# Comma-separated allowlist for browser-origin POST writes
# (defaults include custard.chriskaschner.com + localhost).
PUBLIC_WRITE_ALLOWED_ORIGINS = "https://custard.chriskaschner.com,http://localhost:8080,http://127.0.0.1:8080"
# Comma-separated allowlist for POST /api/alerts/subscribe Origin checks.
ALERT_ALLOWED_ORIGINS = "https://custard.chriskaschner.com,https://custard.today,https://chriskaschner.github.io,http://localhost:8080,http://127.0.0.1:8080"
# CORS origin restriction for browser requests.
# If omitted, Worker defaults to https://custard.chriskaschner.com.
# Set "*" only if you intentionally want open cross-origin reads.
ALLOWED_ORIGIN = "https://custard.chriskaschner.com"
# Base URL for alert email links. Set to your Worker URL in production.
WORKER_BASE_URL = "https://custard.chriskaschner.com"
# Email sender address for alerts. Requires verified domain in Resend.
ALERT_FROM_EMAIL = "alerts@custard.chriskaschner.com"

# Secrets (set via: npx wrangler secret put <NAME>):
#   RESEND_API_KEY — API key from resend.com for sending alert emails
#   REPORT_EMAIL_TO — recipient address for the weekly analytics report email
#   ADMIN_ACCESS_TOKEN — bearer token for admin-only analytics routes

# KV namespace for caching flavor data + alert subscriptions (24h TTL)
[[kv_namespaces]]
binding = "FLAVOR_CACHE"
id = "1642a7da91e144cb9b233b940430250c"

# D1 database for durable historical snapshots
[[d1_databases]]
binding = "DB"
database_name = "custard-snapshots"
database_id = "fa11cb69-1e34-439c-8895-f1c0a938a543"
migrations_dir = "src/migrations"

# Cron triggers:
#   Daily alert check at noon UTC (6-7 AM Central)
#   Weekly digest at 2 PM UTC Sunday (8-9 AM Central)
#   Weekly analytics report at 2 PM UTC Monday (9 AM CT / 8 AM CDT)
[triggers]
crons = ["0 12 * * *", "0 14 * * 7", "0 14 * * 1"]
