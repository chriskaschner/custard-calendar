<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>iOS Widget — Custard Calendar</title>
  <meta name="description" content="Add a Flavor of the Day widget to your iPhone home screen with Scriptable.">
  <meta property="og:title" content="iOS Widget — Custard Calendar">
  <meta property="og:description" content="Add a Flavor of the Day widget to your iPhone home screen with Scriptable.">
  <meta property="og:url" content="https://custard.chriskaschner.com/widget.html">
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://custard.chriskaschner.com/og-calendar.png">
  <meta name="twitter:card" content="summary_large_image">
  <link rel="stylesheet" href="style.css">
  <style>
    .step-card {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1.25rem;
      margin-bottom: 1rem;
    }
    .step-card h3 {
      font-size: 1rem;
      color: #003366;
      margin-bottom: 0.5rem;
    }
    .step-card p, .step-card li {
      font-size: 0.875rem;
      color: #555;
      line-height: 1.5;
      margin-bottom: 0.5rem;
    }
    .step-card code {
      background: #f0f4f8;
      padding: 0.125rem 0.375rem;
      border-radius: 3px;
      font-size: 0.8125rem;
    }
    .step-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 1.5rem;
      height: 1.5rem;
      background: #003366;
      color: white;
      border-radius: 50%;
      font-size: 0.75rem;
      font-weight: 700;
      margin-right: 0.5rem;
      vertical-align: middle;
    }
    /* Widget preview -- follows Apple HIG sizing ratios.
       Small ~155x155pt (1:1), Medium ~329x155pt (~2.13:1).
       16pt content margin, 11pt for graphical layouts.
       No app name on widget (redundant per HIG). */
    .widget-sizes {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
      align-items: start;
    }
    /* -- Shared card shell -- */
    .size-card {
      background: #1a1a1a;
      border-radius: 22px;
      overflow: hidden;
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }
    /* Small: 1:1 ratio, max 170px */
    .size-card.small { width: 170px; height: 170px; display: flex; flex-direction: column; }
    /* Medium: ~2.13:1 ratio */
    .size-card.medium { width: 340px; height: 170px; display: flex; flex-direction: column; }

    /* Branded header bar (Tidbyt-style) */
    .size-card .card-header {
      padding: 6px 16px;
      font-size: 11px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    .size-card .card-header .date-label {
      font-weight: 400;
      opacity: 0.8;
      font-size: 10px;
    }
    /* Content area -- 16px HIG margin */
    .size-card .card-body {
      padding: 8px 16px 12px;
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    /* -- Small card: Fill style, single focus -- */
    .size-card.small .flavor-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
    }
    .size-card .flavor-row .cone-icon svg { display: block; }
    .size-card .flavor-text-col {
      flex: 1;
      min-width: 0;
    }
    .size-card .flavor-name {
      font-size: 15px;
      font-weight: 700;
      line-height: 1.2;
    }
    .size-card .flavor-desc {
      font-size: 11px;
      opacity: 0.6;
      line-height: 1.3;
      margin-top: 2px;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }
    .size-card .rarity-badge {
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 0.05em;
      color: #90CAF9;
      flex-shrink: 0;
    }
    /* -- Medium card: Cell style, 3 rows -- */
    .size-card.medium .card-body { padding: 6px 16px 10px; }
    .size-card.medium .flavor-card {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-height: 0;
    }
    .size-card.medium .flavor-card + .flavor-card {
      border-top: 1px solid rgba(255,255,255,0.08);
      padding-top: 4px;
    }
    .size-card.medium .flavor-card .cone-icon svg { display: block; }
    .size-card.medium .flavor-card .card-text {
      flex: 1;
      min-width: 0;
    }
    .size-card.medium .flavor-card .day {
      font-size: 10px;
      opacity: 0.5;
    }
    .size-card.medium .flavor-card .fname {
      font-size: 13px;
      font-weight: 700;
      line-height: 1.2;
    }
    .size-card.medium .flavor-card .fdesc {
      font-size: 10px;
      opacity: 0.55;
      line-height: 1.25;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .store-filter {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .store-filter select, .store-filter input {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.875rem;
    }
    #store-list {
      max-height: 180px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 0.5rem;
    }
    #store-list .store-option {
      padding: 0.4rem 0.6rem;
      cursor: pointer;
      font-size: 0.8125rem;
      border-bottom: 1px solid #f0f0f0;
    }
    #store-list .store-option:hover,
    #store-list .store-option.selected { background: #e8f0fe; }
    #store-list .store-option .slug-hint {
      font-size: 0.75rem;
      color: #999;
      margin-left: 0.25rem;
    }
    .script-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }
    .script-actions a, .script-actions button {
      display: inline-block;
      padding: 0.6rem 1.25rem;
      background: #005696;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
    }
    .script-actions a:hover, .script-actions button:hover { background: #003366; }
  </style>
</head>
<body>
  <header>
    <h1>Custard Calendar</h1>
    <p>Add today's Flavor of the Day to your iPhone home screen.</p>
    <nav class="nav-links">
      <a href="index.html">Forecast</a>
      <a href="calendar.html">Calendar</a>
      <a href="map.html">Map</a>
      <a href="radar.html">Radar</a>
      <a href="alerts.html">Alerts</a>
      <a href="siri.html">Siri</a>
      <a href="forecast-map.html">Fronts</a>
      <a href="quiz.html">Quiz</a>
      <a href="widget.html" class="nav-active">Widget</a>
    </nav>
  </header>

  <main>
    <section>
      <h2>Widget Preview</h2>
      <p style="color:#666;font-size:0.875rem;margin-bottom:0.75rem;">What you'll see on your home screen.</p>
      <div class="widget-sizes">
        <div class="size-card small" id="preview-small">
          <div class="card-header" id="small-header">
            <span id="preview-location">Mt. Horeb</span>
            <span class="date-label" id="preview-date"></span>
          </div>
          <div class="card-body">
            <div class="flavor-row">
              <span class="cone-icon" id="preview-cone"></span>
              <div class="flavor-text-col">
                <div class="flavor-name" id="preview-flavor">Loading...</div>
                <div class="flavor-desc" id="preview-desc"></div>
              </div>
            </div>
            <div class="rarity-badge" id="preview-rarity"></div>
          </div>
        </div>
        <div class="size-card medium" id="preview-medium">
          <div class="card-header" id="medium-header">
            <span id="preview-location-med">Mt. Horeb</span>
            <span class="date-label">This Week</span>
          </div>
          <div class="card-body" id="preview-rows"></div>
        </div>
      </div>
    </section>

    <section style="margin-top:1.5rem;">
      <h2>Pick Your Store</h2>
      <p style="color:#666;font-size:0.875rem;margin-bottom:0.75rem;">Choose your store and the preview above updates live. The script we copy in the next step is pre-configured for this store.</p>

      <div class="store-filter">
        <select id="state-filter">
          <option value="">All States</option>
        </select>
        <input type="text" id="city-search" placeholder="Search city or store...">
      </div>
      <div id="store-list"></div>
    </section>

    <section style="margin-top:1.5rem;">
      <h2>Setup</h2>

      <div class="step-card">
        <h3><span class="step-number">1</span> Install Scriptable</h3>
        <p>Download <a href="https://apps.apple.com/app/scriptable/id1405459188" target="_blank" rel="noopener">Scriptable</a> from the App Store (free).</p>
      </div>

      <div class="step-card">
        <h3><span class="step-number">2</span> Copy the Script</h3>
        <p>This copies a script pre-configured for <strong id="script-store-label">your store</strong>. Open Scriptable, tap <strong>+</strong>, and paste.</p>
        <div class="script-actions">
          <button id="copy-script">Copy Script for My Store</button>
          <a href="https://raw.githubusercontent.com/chriskaschner/custard-calendar/main/widgets/custard-today.js" target="_blank" rel="noopener">View Script</a>
        </div>
        <p style="font-size:0.75rem;color:#888;margin-top:0.5rem;">On iOS, if copy doesn't work, tap "View Script" and manually change the slug on line 16.</p>
      </div>

      <div class="step-card">
        <h3><span class="step-number">3</span> Add Widget to Home Screen</h3>
        <ol style="padding-left:1.25rem;">
          <li>Long-press your home screen, tap <strong>+</strong> in the top corner.</li>
          <li>Search for <strong>Scriptable</strong>, choose Small or Medium size.</li>
          <li>Long-press the new widget, tap <strong>Edit Widget</strong>.</li>
          <li>Set <strong>Script</strong> to the script you just created.</li>
        </ol>
        <p style="font-size:0.75rem;color:#888;margin-top:0.5rem;">No need to set a parameter -- the store is already baked into the script.</p>
      </div>

      <div class="step-card">
        <h3><span class="step-number">4</span> Done</h3>
        <p>The widget refreshes automatically throughout the day. Small shows today's flavor with cone icon and description; medium shows a 3-day schedule with cone icons, flavor names, and descriptions.</p>
      </div>
    </section>
  </main>

  <footer>
    <p>Not affiliated with any restaurant. Flavor data sourced from restaurant websites.</p>
  </footer>

  <script src="planner-shared.js"></script>
  <script>var WORKER_BASE = CustardPlanner.WORKER_BASE;</script>
  <script src="cone-renderer.js"></script>
  <script>
    var SCRIPT_URL = 'https://raw.githubusercontent.com/chriskaschner/custard-calendar/main/widgets/custard-today.js';
    var allStores = [];
    var selectedSlug = null; // set to random store after load

    var stateFilter = document.getElementById('state-filter');
    var citySearch = document.getElementById('city-search');
    var storeList = document.getElementById('store-list');
    var copyScriptBtn = document.getElementById('copy-script');
    var scriptStoreLabel = document.getElementById('script-store-label');

    // Load stores, pick a random WI store to start
    async function loadStores() {
      try {
        var resp = await fetch('stores.json?v=' + new Date().toISOString().slice(0, 10));
        var data = await resp.json();
        allStores = data.stores || [];
        populateStates();

        // Pick a random WI store as the initial selection
        var wiStores = allStores.filter(function(s) { return s.state === 'WI'; });
        var pool = wiStores.length > 0 ? wiStores : allStores;
        var randomStore = pool[Math.floor(Math.random() * pool.length)];
        if (randomStore) {
          selectedSlug = randomStore.slug;
        } else {
          selectedSlug = 'mt-horeb';
        }

        renderStores();
        loadPreview(selectedSlug);
        updateScriptLabel();
        prefetchScript();
      } catch (err) {
        storeList.innerHTML = '<div style="padding:0.5rem;color:#c00">Failed to load stores</div>';
        selectedSlug = 'mt-horeb';
        loadPreview(selectedSlug);
        prefetchScript();
      }
    }

    function populateStates() {
      var states = [...new Set(allStores.map(function(s) { return s.state; }))].sort();
      for (var i = 0; i < states.length; i++) {
        var opt = document.createElement('option');
        opt.value = states[i];
        opt.textContent = states[i];
        stateFilter.appendChild(opt);
      }
    }

    var BRAND_DISPLAY = {
      kopps: "Kopp's", gilles: "Gille's", hefners: "Hefner's",
      kraverz: "Kraverz", oscars: "Oscar's"
    };

    function storeLabel(s) {
      var prefix = s.brand ? ((BRAND_DISPLAY[s.brand] || s.brand) + ' -- ') : '';
      return prefix + s.city + ', ' + s.state + ' -- ' + s.address;
    }

    function renderStores() {
      var state = stateFilter.value;
      var query = citySearch.value.toLowerCase().trim();
      var filtered = allStores.filter(function(s) {
        if (state && s.state !== state) return false;
        if (query) {
          var searchable = (s.name + ' ' + s.city + ' ' + s.address + ' ' + s.slug + ' ' + (s.brand || '')).toLowerCase();
          return searchable.indexOf(query) !== -1;
        }
        return true;
      }).slice(0, 50);

      storeList.innerHTML = '';
      for (var i = 0; i < filtered.length; i++) {
        var s = filtered[i];
        var div = document.createElement('div');
        div.className = 'store-option' + (s.slug === selectedSlug ? ' selected' : '');
        div.innerHTML = storeLabel(s) + '<span class="slug-hint">' + s.slug + '</span>';
        div.dataset.slug = s.slug;
        div.addEventListener('click', function() {
          selectStore(this.dataset.slug);
        });
        storeList.appendChild(div);
      }
    }

    function updateScriptLabel() {
      var store = allStores.find(function(s) { return s.slug === selectedSlug; });
      if (store) {
        var brand = store.brand ? (BRAND_DISPLAY[store.brand] || store.brand) : '';
        var label = brand ? (brand + ' -- ' + store.city) : (store.city + ', ' + store.state);
        scriptStoreLabel.textContent = label;
      } else {
        scriptStoreLabel.textContent = selectedSlug;
      }
    }

    function selectStore(slug) {
      selectedSlug = slug;
      updateScriptLabel();
      renderStores();
      loadPreview(slug);
    }

    stateFilter.addEventListener('change', renderStores);
    citySearch.addEventListener('input', renderStores);

    // --- Script copy with slug injection ---

    function copyToClipboardFallback(text) {
      var ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed';
      ta.style.left = '-9999px';
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      try { document.execCommand('copy'); } catch (e) { /* ignore */ }
      document.body.removeChild(ta);
    }

    var cachedScript = null;

    function prefetchScript() {
      fetch(SCRIPT_URL).then(function(r) { return r.ok ? r.text() : null; }).then(function(t) {
        cachedScript = t;
      }).catch(function() {});
    }

    // Replace the default slug in the script with the user's selected store
    function personalizeScript(scriptText, slug) {
      return scriptText.replace(
        /var slug = \(args\.widgetParameter \|\| ".*?"\)\.trim\(\);/,
        'var slug = (args.widgetParameter || "' + slug + '").trim();'
      );
    }

    function doCopy(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(function() {
          copyScriptBtn.textContent = 'Copied!';
          setTimeout(function() { copyScriptBtn.textContent = 'Copy Script for My Store'; }, 2000);
        }).catch(function() {
          copyToClipboardFallback(text);
          copyScriptBtn.textContent = 'Copied!';
          setTimeout(function() { copyScriptBtn.textContent = 'Copy Script for My Store'; }, 2000);
        });
      } else {
        copyToClipboardFallback(text);
        copyScriptBtn.textContent = 'Copied!';
        setTimeout(function() { copyScriptBtn.textContent = 'Copy Script for My Store'; }, 2000);
      }
    }

    copyScriptBtn.addEventListener('click', function() {
      if (!cachedScript) {
        window.open(SCRIPT_URL, '_blank');
        return;
      }
      var personalized = personalizeScript(cachedScript, selectedSlug || 'mt-horeb');
      doCopy(personalized);
    });

    // --- Preview ---

    function truncateDesc(desc, maxLen) {
      if (!desc) return '';
      if (desc.length <= maxLen) return desc;
      return desc.substring(0, maxLen - 1).trim() + '\u2026';
    }

    async function loadPreview(slug) {
      if (typeof loadFlavorColors === 'function') {
        try { await loadFlavorColors(); } catch (e) { /* best effort */ }
      }

      try {
        var todayResp = await fetch(WORKER_BASE + '/api/v1/today?slug=' + encodeURIComponent(slug));
        if (todayResp.ok) {
          var today = await todayResp.json();
          document.getElementById('preview-flavor').textContent = today.flavor || 'No flavor';
          document.getElementById('preview-date').textContent = formatDateLabel(today.date);

          var descEl = document.getElementById('preview-desc');
          descEl.textContent = truncateDesc(today.description, 80);

          var coneEl = document.getElementById('preview-cone');
          if (typeof renderMiniConeSVG === 'function' && today.flavor) {
            coneEl.innerHTML = renderMiniConeSVG(today.flavor, 6);
          }

          var rarityEl = document.getElementById('preview-rarity');
          if (today.rarity && today.rarity.label) {
            rarityEl.textContent = today.rarity.label.toUpperCase();
          } else {
            rarityEl.textContent = '';
          }

          var brandKey = today.brand || "Culver's";
          var brandColors = {
            "Culver's": { bg: '#005696', text: '#fff' },
            "Kopp's":   { bg: '#1a1a1a', text: '#fff' },
            "Gille's":  { bg: '#EBCC35', text: '#1a1a1a' },
            "Hefner's": { bg: '#93BE46', text: '#1a1a1a' },
            "Kraverz":  { bg: '#CE742D', text: '#fff' },
            "Oscar's":  { bg: '#BC272C', text: '#fff' }
          };
          var bc = brandColors[brandKey] || brandColors["Culver's"];

          // Extract city from store name (e.g. "Culver's of Mt. Horeb, WI" -> "Mt. Horeb")
          var city = '';
          var storeName = today.store || '';
          var ofMatch = storeName.match(/of\s+(.+?)(?:,|\s*-)/);
          if (ofMatch) { city = ofMatch[1].trim(); }
          else {
            var commaMatch = storeName.match(/^(.+?),/);
            if (commaMatch) city = commaMatch[1].trim();
          }
          if (!city) city = selectedSlug;

          // Set header bars
          var smallHeader = document.getElementById('small-header');
          smallHeader.style.background = bc.bg;
          smallHeader.style.color = bc.text;
          document.getElementById('preview-location').textContent = city;

          var medHeader = document.getElementById('medium-header');
          medHeader.style.background = bc.bg;
          medHeader.style.color = bc.text;
          document.getElementById('preview-location-med').textContent = city;
        }

        var flavorsResp = await fetch(WORKER_BASE + '/api/v1/flavors?slug=' + encodeURIComponent(slug));
        if (flavorsResp.ok) {
          var data = await flavorsResp.json();
          var todayStr = new Date().toISOString().slice(0, 10);
          var upcoming = (data.flavors || []).filter(function(f) { return f.date >= todayStr; }).slice(0, 3);
          var rowsEl = document.getElementById('preview-rows');
          rowsEl.innerHTML = '';
          for (var i = 0; i < upcoming.length; i++) {
            var card = document.createElement('div');
            card.className = 'flavor-card';
            var coneSvg = '';
            if (typeof renderMiniConeSVG === 'function') {
              coneSvg = renderMiniConeSVG(upcoming[i].title, 4);
            }
            var descHtml = upcoming[i].description
              ? '<div class="fdesc">' + escapeHtml(truncateDesc(upcoming[i].description, 70)) + '</div>'
              : '';
            card.innerHTML = '<span class="cone-icon">' + coneSvg + '</span>'
              + '<div class="card-text">'
              + '<div class="day">' + formatDateLabel(upcoming[i].date) + '</div>'
              + '<div class="fname">' + escapeHtml(upcoming[i].title) + '</div>'
              + descHtml
              + '</div>';
            rowsEl.appendChild(card);
          }
        }
      } catch (err) {
        document.getElementById('preview-flavor').textContent = 'Preview unavailable';
      }
    }

    function formatDateLabel(dateStr) {
      if (!dateStr) return '';
      var d = new Date(dateStr + 'T12:00:00');
      var today = new Date(); today.setHours(12, 0, 0, 0);
      var tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);
      if (d.toDateString() === today.toDateString()) return 'Today';
      if (d.toDateString() === tomorrow.toDateString()) return 'Tomorrow';
      return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    }

    var escapeHtml = CustardPlanner.escapeHtml;

    loadStores();

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(function() {});
    }
  </script>
</body>
</html>
