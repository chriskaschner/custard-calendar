<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>iOS Widget — Custard Calendar</title>
  <meta name="description" content="Add a Flavor of the Day widget to your iPhone home screen with Scriptable.">
  <meta property="og:title" content="iOS Widget — Custard Calendar">
  <meta property="og:description" content="Add a Flavor of the Day widget to your iPhone home screen with Scriptable.">
  <meta property="og:url" content="https://custard.chriskaschner.com/widget.html">
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://custard.chriskaschner.com/og/page/widget.svg">
  <meta name="twitter:card" content="summary_large_image">
  <link rel="stylesheet" href="style.css">
  <style>
    .step-card {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1.25rem;
      margin-bottom: 1rem;
    }
    .step-card h3 {
      font-size: 1rem;
      color: #005696;
      margin-bottom: 0.5rem;
    }
    .step-card p, .step-card li {
      font-size: 0.875rem;
      color: #555;
      line-height: 1.5;
      margin-bottom: 0.5rem;
    }
    .step-card code {
      background: #f0f4f8;
      padding: 0.125rem 0.375rem;
      border-radius: 3px;
      font-size: 0.8125rem;
    }
    .step-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 1.5rem;
      height: 1.5rem;
      background: #005696;
      color: white;
      border-radius: 50%;
      font-size: 0.75rem;
      font-weight: 700;
      margin-right: 0.5rem;
      vertical-align: middle;
    }
    /* Widget preview -- follows Apple HIG sizing ratios.
       Small ~155x155pt (1:1), Medium ~329x155pt (~2.13:1).
       16pt content margin, 11pt for graphical layouts.
       No app name on widget (redundant per HIG). */
    .widget-sizes {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
      align-items: start;
      overflow-x: auto;
      padding-bottom: 0.25rem;
    }
    /* -- Shared card shell -- */
    .size-card {
      background: #1a1a1a;
      border-radius: 22px;
      overflow: hidden;
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      flex-shrink: 0;
    }
    /* Small: 1:1 ratio */
    .size-card.small { width: 170px; height: 170px; display: flex; flex-direction: column; }
    /* Medium 3-day: ~2.13:1 ratio */
    .size-card.medium { width: 340px; height: 170px; display: flex; flex-direction: column; }
    /* Medium 3-store: same physical size */
    .size-card.multi { width: 340px; height: 170px; display: flex; flex-direction: column; }
    .size-card.multi .card-header { border-bottom: 1px solid rgba(255,255,255,0.08); }

    /* Branded header bar (Tidbyt-style) */
    .size-card .card-header {
      padding: 6px 16px;
      font-size: 11px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    .size-card .card-header .date-label {
      font-weight: 400;
      opacity: 0.8;
      font-size: 10px;
    }
    /* Content area -- 16px HIG margin */
    .size-card .card-body {
      padding: 8px 16px 12px;
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    /* -- Small card: Fill style, single focus -- */
    .size-card.small .flavor-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
    }
    .size-card .flavor-row .cone-icon svg { display: block; }
    .size-card .flavor-text-col {
      flex: 1;
      min-width: 0;
    }
    .size-card .flavor-name {
      font-size: 15px;
      font-weight: 700;
      line-height: 1.2;
    }
    .size-card .flavor-desc {
      font-size: 11px;
      opacity: 0.6;
      line-height: 1.3;
      margin-top: 2px;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }
    .size-card .rarity-badge {
      font-size: 9px;
      font-weight: 700;
      letter-spacing: 0.05em;
      color: #90CAF9;
      flex-shrink: 0;
    }
    /* -- Medium card: Cell style, 3 rows -- */
    .size-card.medium .card-body { padding: 6px 16px 10px; }
    .size-card.medium .flavor-card {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-height: 0;
    }
    .size-card.medium .flavor-card + .flavor-card {
      border-top: 1px solid rgba(255,255,255,0.08);
      padding-top: 4px;
    }
    .size-card.medium .flavor-card .cone-icon svg { display: block; }
    .size-card.medium .flavor-card .card-text {
      flex: 1;
      min-width: 0;
    }
    .size-card.medium .flavor-card .day {
      font-size: 10px;
      opacity: 0.5;
    }
    .size-card.medium .flavor-card .fname {
      font-size: 13px;
      font-weight: 700;
      line-height: 1.2;
    }
    .size-card.medium .flavor-card .fdesc {
      font-size: 10px;
      opacity: 0.55;
      line-height: 1.25;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    /* -- Multi card: 3 store rows -- */
    .size-card.multi .card-body { padding: 0 16px 6px; }
    .multi-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-height: 0;
    }
    .multi-row + .multi-row { border-top: 1px solid rgba(255,255,255,0.08); }
    .multi-row .mr-city { font-size: 9px; opacity: 0.45; flex-shrink: 0; }
    .multi-row .mr-flavor {
      font-size: 12px;
      font-weight: 700;
      line-height: 1.2;
      flex: 1;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .multi-row .mr-rarity { font-size: 8px; font-weight: 700; color: #90CAF9; flex-shrink: 0; }
    /* -- Rotated cones on medium and multi cards -- */
    .size-card.medium .cone-icon,
    .size-card.multi .cone-icon {
      transform: rotate(-45deg);
      transform-origin: center;
      flex-shrink: 0;
      display: inline-block;
    }
    /* -- Widget type selector -- */
    .widget-type-selector {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
      flex-wrap: wrap;
    }
    .type-btn {
      padding: 0.375rem 0.875rem;
      background: #f0f4f8;
      border: 1.5px solid #ddd;
      border-radius: 20px;
      font-size: 0.8125rem;
      font-weight: 500;
      cursor: pointer;
      color: #444;
    }
    .type-btn.active {
      background: #005696;
      border-color: #005696;
      color: white;
      font-weight: 600;
    }
    .type-btn:hover:not(.active) { background: #e0e8f0; border-color: #b0bdd0; }
    /* -- Card selection ring -- */
    .size-card.selected {
      outline: 3px solid #005696;
      outline-offset: 2px;
    }
    /* -- Store filter -- */
    .store-filter {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .store-filter select, .store-filter input {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.875rem;
    }
    #store-list {
      max-height: 180px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 0.5rem;
    }
    #store-list .store-option {
      padding: 0.4rem 0.6rem;
      cursor: pointer;
      font-size: 0.8125rem;
      border-bottom: 1px solid #f0f0f0;
    }
    #store-list .store-option:hover,
    #store-list .store-option.selected { background: #e8f0fe; }
    #store-list .store-option .slug-hint {
      font-size: 0.75rem;
      color: #999;
      margin-left: 0.25rem;
    }
    /* -- Multi-slot picker -- */
    .store-slots {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    .slot-card {
      flex: 1;
      padding: 0.5rem 0.75rem;
      background: white;
      border: 1.5px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8125rem;
    }
    .slot-card.active { border-color: #005696; background: #e8f0fe; }
    .slot-card:hover:not(.active) { background: #f5f5f5; }
    .slot-role {
      display: block;
      font-size: 0.7rem;
      color: #888;
      margin-bottom: 0.2rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .slot-name {
      display: block;
      font-weight: 600;
      color: #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .script-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }
    .script-actions a, .script-actions button {
      display: inline-block;
      padding: 0.6rem 1.25rem;
      background: #005696;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
    }
    .script-actions a:hover, .script-actions button:hover { background: #004a80; }
  </style>
</head>
<body>
  <header>
    <h1>Custard Calendar</h1>
    <p>Add today's Flavor of the Day to your iPhone home screen.</p>
    <nav class="nav-links">
      <a href="index.html">Forecast</a>
      <a href="calendar.html">Calendar</a>
      <a href="map.html">Map</a>
      <a href="radar.html">Radar</a>
      <a href="alerts.html">Alerts</a>
      <a href="siri.html">Siri</a>
      <a href="forecast-map.html">Fronts</a>
      <a href="quiz.html">Quiz</a>
      <a href="widget.html" class="nav-active">Widget</a>
    </nav>
  </header>

  <main>
    <section>
      <h2>Widget Preview</h2>
      <p style="color:#666;font-size:0.875rem;margin-bottom:0.75rem;">What you'll see on your home screen.</p>
      <div class="widget-sizes">
        <!-- Small 1x1 -->
        <div class="size-card small selected" id="preview-small">
          <div class="card-header" id="small-header">
            <span class="date-label" id="preview-date"></span>
            <span id="preview-location">Mt. Horeb</span>
          </div>
          <div class="card-body">
            <div class="flavor-row">
              <span class="cone-icon" id="preview-cone" aria-hidden="true"></span>
              <div class="flavor-text-col">
                <div class="flavor-name" id="preview-flavor">Loading...</div>
                <div class="flavor-desc" id="preview-desc"></div>
              </div>
            </div>
            <div class="rarity-badge" id="preview-rarity"></div>
          </div>
        </div>
        <!-- Medium 3-day -->
        <div class="size-card medium" id="preview-medium">
          <div class="card-header" id="medium-header">
            <span class="date-label">This Week</span>
            <span id="preview-location-med">Mt. Horeb</span>
          </div>
          <div class="card-body" id="preview-rows"></div>
        </div>
        <!-- Medium 3-store -->
        <div class="size-card multi" id="preview-multi">
          <div class="card-header" id="multi-header">
            <span>Today</span>
            <span class="date-label" id="multi-stores-label">Your Stores</span>
          </div>
          <div class="card-body" id="preview-multi-rows"></div>
        </div>
      </div>
      <!-- Type selector -->
      <div class="widget-type-selector">
        <button class="type-btn active" data-type="small">Small — Today</button>
        <button class="type-btn" data-type="3day">Medium — 3 Day</button>
        <button class="type-btn" data-type="3store">Medium — 3 Store</button>
      </div>
    </section>

    <section style="margin-top:1.5rem;">
      <h2>Pick Your Store</h2>

      <!-- Single-store description (visible for small/3day) -->
      <div id="single-store-picker">
        <p style="color:#666;font-size:0.875rem;margin-bottom:0.75rem;">Choose your store and the preview above updates live. The script we copy in the next step is pre-configured for this store.</p>
      </div>

      <!-- Multi-slot picker (visible for 3store) -->
      <div id="multi-slot-picker" style="display:none">
        <p style="color:#666;font-size:0.875rem;margin-bottom:0.75rem;">Pick up to 3 stores. Tap a slot to select it, then click a store from the list.</p>
        <div class="store-slots">
          <div class="slot-card active" data-slot="primary">
            <span class="slot-role">Primary</span>
            <span class="slot-name" id="slot-primary-name">Pick a store</span>
          </div>
          <div class="slot-card" data-slot="backup1">
            <span class="slot-role">Backup 1</span>
            <span class="slot-name" id="slot-backup1-name">Pick a store</span>
          </div>
          <div class="slot-card" data-slot="backup2">
            <span class="slot-role">Backup 2</span>
            <span class="slot-name" id="slot-backup2-name">Pick a store</span>
          </div>
        </div>
      </div>

      <!-- Shared search + list (always visible) -->
      <div class="store-filter">
        <select id="state-filter">
          <option value="">All States</option>
        </select>
        <input type="text" id="city-search" placeholder="Search city or store...">
      </div>
      <div id="store-list"></div>
    </section>

    <section style="margin-top:1.5rem;">
      <h2>Setup</h2>

      <div class="step-card">
        <h3><span class="step-number">1</span> Install Scriptable</h3>
        <p>Download <a href="https://apps.apple.com/app/scriptable/id1405459188" target="_blank" rel="noopener">Scriptable</a> from the App Store (free).</p>
      </div>

      <div class="step-card">
        <h3><span class="step-number">2</span> Copy the Script</h3>
        <p>This copies a script pre-configured for <strong id="script-store-label">your store</strong>. Open Scriptable, tap <strong>+</strong>, and paste.</p>
        <div class="script-actions">
          <button id="copy-script">Copy Script for My Store</button>
          <a href="https://raw.githubusercontent.com/chriskaschner/custard-calendar/main/widgets/custard-today.js" target="_blank" rel="noopener">View Script</a>
        </div>
        <p style="font-size:0.75rem;color:#888;margin-top:0.5rem;">On iOS, if copy doesn't work, tap "View Script" and manually change the slug on line 16.</p>
      </div>

      <div class="step-card">
        <h3><span class="step-number">3</span> Add Widget to Home Screen</h3>
        <ol style="padding-left:1.25rem;">
          <li>Long-press your home screen, tap <strong>+</strong> in the top corner.</li>
          <li>Search for <strong>Scriptable</strong>, choose Small or Medium size.</li>
          <li>Long-press the new widget, tap <strong>Edit Widget</strong>.</li>
          <li>Set <strong>Script</strong> to the script you just created.</li>
        </ol>
        <p style="font-size:0.75rem;color:#888;margin-top:0.5rem;">No need to set a parameter — the store is already baked into the script.</p>
      </div>

      <div class="step-card">
        <h3><span class="step-number">4</span> Done</h3>
        <p>The widget refreshes automatically throughout the day. Small shows today's flavor with cone icon; medium 3-day shows a 3-day schedule; medium 3-store shows today's flavor at three different locations.</p>
      </div>
    </section>
  </main>

  <footer>
    <p><a href="privacy.html">Privacy</a> &middot; Not affiliated with any restaurant. Flavor data sourced from restaurant websites.</p>
    <div class="page-share-mount" id="page-share"></div>
  </footer>

  <script src="planner-shared.js"></script>
  <script>CustardPlanner.initShareButton('page-share');</script>
  <script>var WORKER_BASE = CustardPlanner.WORKER_BASE;</script>
  <script src="cone-renderer.js"></script>
  <script>
    var SCRIPT_URL = 'https://raw.githubusercontent.com/chriskaschner/custard-calendar/main/widgets/custard-today.js';
    var allStores = [];
    var widgetType = 'small'; // 'small' | '3day' | '3store'
    var selectedSlug = null;  // for small/3day single-store previews
    var primarySlug = null;
    var backup1Slug = null;
    var backup2Slug = null;
    var activeSlot = 'primary';

    var stateFilter = document.getElementById('state-filter');
    var citySearch = document.getElementById('city-search');
    var storeList = document.getElementById('store-list');
    var copyScriptBtn = document.getElementById('copy-script');
    var scriptStoreLabel = document.getElementById('script-store-label');

    // --- Widget type selector ---

    function getCopyBtnLabel() {
      return widgetType === '3store' ? 'Copy Script for 3 Stores' : 'Copy Script for My Store';
    }

    function updateCardSelection() {
      document.getElementById('preview-small').classList.toggle('selected', widgetType === 'small');
      document.getElementById('preview-medium').classList.toggle('selected', widgetType === '3day');
      document.getElementById('preview-multi').classList.toggle('selected', widgetType === '3store');
    }

    function updatePickerVisibility() {
      var single = document.getElementById('single-store-picker');
      var multi = document.getElementById('multi-slot-picker');
      if (widgetType === '3store') {
        single.style.display = 'none';
        multi.style.display = 'block';
      } else {
        single.style.display = 'block';
        multi.style.display = 'none';
      }
    }

    document.querySelectorAll('.type-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        widgetType = this.dataset.type;
        document.querySelectorAll('.type-btn').forEach(function(b) { b.classList.remove('active'); });
        this.classList.add('active');
        updateCardSelection();
        updatePickerVisibility();
        copyScriptBtn.textContent = getCopyBtnLabel();
        updateScriptLabel();
        renderStores();
      });
    });

    // --- Store loading and init ---

    async function loadStores() {
      try {
        var resp = await fetch('stores.json?v=' + new Date().toISOString().slice(0, 10));
        var data = await resp.json();
        allStores = data.stores || [];
        populateStates();

        // Pick 3 random WI stores for default multi-store preview
        var wiStores = allStores.filter(function(s) { return s.state === 'WI'; });
        var pool = wiStores.length > 0 ? wiStores : allStores;
        var shuffled = pool.slice().sort(function() { return Math.random() - 0.5; }).slice(0, 3);
        primarySlug = shuffled[0] ? shuffled[0].slug : 'mt-horeb';
        backup1Slug = shuffled[1] ? shuffled[1].slug : null;
        backup2Slug = shuffled[2] ? shuffled[2].slug : null;
        selectedSlug = primarySlug;

        updateSlotUI();
        renderStores();
        loadPreview(selectedSlug);
        loadMultiPreview();
        updateScriptLabel();
        prefetchScript();
      } catch (err) {
        storeList.innerHTML = '<div style="padding:0.5rem;color:#c00">Failed to load stores</div>';
        selectedSlug = 'mt-horeb';
        primarySlug = 'mt-horeb';
        loadPreview(selectedSlug);
        loadMultiPreview();
        prefetchScript();
      }
    }

    function populateStates() {
      var states = [...new Set(allStores.map(function(s) { return s.state; }))].sort();
      for (var i = 0; i < states.length; i++) {
        var opt = document.createElement('option');
        opt.value = states[i];
        opt.textContent = states[i];
        stateFilter.appendChild(opt);
      }
    }

    var BRAND_DISPLAY = {
      kopps: "Kopp's", gilles: "Gille's", hefners: "Hefner's",
      kraverz: "Kraverz", oscars: "Oscar's"
    };

    function storeLabel(s) {
      var prefix = s.brand ? ((BRAND_DISPLAY[s.brand] || s.brand) + ' -- ') : '';
      return prefix + s.city + ', ' + s.state + ' -- ' + s.address;
    }

    function renderStores() {
      var state = stateFilter.value;
      var query = citySearch.value.toLowerCase().trim();
      var filtered = allStores.filter(function(s) {
        if (state && s.state !== state) return false;
        if (query) {
          var searchable = (s.name + ' ' + s.city + ' ' + s.address + ' ' + s.slug + ' ' + (s.brand || '')).toLowerCase();
          return searchable.indexOf(query) !== -1;
        }
        return true;
      }).slice(0, 50);

      storeList.innerHTML = '';
      for (var i = 0; i < filtered.length; i++) {
        var s = filtered[i];
        var isSelected = (widgetType === '3store')
          ? (s.slug === primarySlug || s.slug === backup1Slug || s.slug === backup2Slug)
          : (s.slug === selectedSlug);
        var div = document.createElement('div');
        div.className = 'store-option' + (isSelected ? ' selected' : '');
        div.innerHTML = storeLabel(s) + '<span class="slug-hint">' + s.slug + '</span>';
        div.dataset.slug = s.slug;
        div.addEventListener('click', function() { selectStore(this.dataset.slug); });
        storeList.appendChild(div);
      }
    }

    function updateScriptLabel() {
      if (widgetType === '3store') {
        var count = [primarySlug, backup1Slug, backup2Slug].filter(Boolean).length;
        scriptStoreLabel.textContent = count + ' store' + (count !== 1 ? 's' : '') + ' selected';
      } else {
        var store = allStores.find(function(s) { return s.slug === selectedSlug; });
        if (store) {
          var brand = store.brand ? (BRAND_DISPLAY[store.brand] || store.brand) : '';
          scriptStoreLabel.textContent = brand ? (brand + ' -- ' + store.city) : (store.city + ', ' + store.state);
        } else {
          scriptStoreLabel.textContent = selectedSlug || 'your store';
        }
      }
    }

    // --- Multi-slot picker logic ---

    function updateSlotUI() {
      var slotMap = { primary: primarySlug, backup1: backup1Slug, backup2: backup2Slug };
      for (var slot in slotMap) {
        var nameEl = document.getElementById('slot-' + slot + '-name');
        if (!nameEl) continue;
        var s = slotMap[slot];
        if (s) {
          var store = allStores.find(function(st) { return st.slug === s; });
          nameEl.textContent = store ? (store.city + ', ' + store.state) : s;
        } else {
          nameEl.textContent = 'Pick a store';
        }
      }
      document.querySelectorAll('.slot-card').forEach(function(c) {
        c.classList.toggle('active', c.dataset.slot === activeSlot);
      });
    }

    document.querySelectorAll('.slot-card').forEach(function(card) {
      card.addEventListener('click', function() {
        activeSlot = this.dataset.slot;
        updateSlotUI();
      });
    });

    function selectStore(slug) {
      if (widgetType === '3store') {
        if (slug === primarySlug) {
          primarySlug = null;
          activeSlot = 'primary';
        } else if (slug === backup1Slug) {
          backup1Slug = null;
          activeSlot = 'backup1';
        } else if (slug === backup2Slug) {
          backup2Slug = null;
          activeSlot = 'backup2';
        } else {
          if (activeSlot === 'primary') {
            primarySlug = slug;
            if (!backup1Slug) activeSlot = 'backup1';
            else if (!backup2Slug) activeSlot = 'backup2';
          } else if (activeSlot === 'backup1') {
            backup1Slug = slug;
            if (!backup2Slug) activeSlot = 'backup2';
            else if (!primarySlug) activeSlot = 'primary';
          } else if (activeSlot === 'backup2') {
            backup2Slug = slug;
            if (!primarySlug) activeSlot = 'primary';
            else if (!backup1Slug) activeSlot = 'backup1';
          }
        }
        updateSlotUI();
        renderStores();
        loadMultiPreview();
        updateScriptLabel();
      } else {
        selectedSlug = slug;
        updateScriptLabel();
        renderStores();
        loadPreview(slug);
      }
    }

    stateFilter.addEventListener('change', renderStores);
    citySearch.addEventListener('input', renderStores);

    // --- Script copy with slug injection ---

    function copyToClipboardFallback(text) {
      var ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed';
      ta.style.left = '-9999px';
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      try { document.execCommand('copy'); } catch (e) { /* ignore */ }
      document.body.removeChild(ta);
    }

    var cachedScript = null;

    function prefetchScript() {
      fetch(SCRIPT_URL).then(function(r) { return r.ok ? r.text() : null; }).then(function(t) {
        cachedScript = t;
      }).catch(function() {});
    }

    function personalizeScript(scriptText, slug) {
      return scriptText.replace(
        /var slug = \(args\.widgetParameter \|\| ".*?"\)\.trim\(\);/,
        'var slug = (args.widgetParameter || "' + slug + '").trim();'
      );
    }

    function personalizeMultiScript(scriptText, p, b1, b2) {
      var slugsList = JSON.stringify([p || 'mt-horeb', b1, b2]);
      return scriptText.replace(
        /var slug = \(args\.widgetParameter \|\| ".*?"\)\.trim\(\);/,
        'var slug = (args.widgetParameter || "' + (p || 'mt-horeb') + '").trim();\nvar MODE = "multi";\nvar slugs = ' + slugsList + ';'
      );
    }

    function doCopy(text) {
      var resetLabel = getCopyBtnLabel();
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(function() {
          copyScriptBtn.textContent = 'Copied!';
          setTimeout(function() { copyScriptBtn.textContent = resetLabel; }, 2000);
        }).catch(function() {
          copyToClipboardFallback(text);
          copyScriptBtn.textContent = 'Copied!';
          setTimeout(function() { copyScriptBtn.textContent = resetLabel; }, 2000);
        });
      } else {
        copyToClipboardFallback(text);
        copyScriptBtn.textContent = 'Copied!';
        setTimeout(function() { copyScriptBtn.textContent = resetLabel; }, 2000);
      }
    }

    copyScriptBtn.addEventListener('click', function() {
      if (!cachedScript) {
        window.open(SCRIPT_URL, '_blank');
        return;
      }
      var personalized;
      if (widgetType === '3store') {
        personalized = personalizeMultiScript(cachedScript, primarySlug, backup1Slug, backup2Slug);
      } else {
        personalized = personalizeScript(cachedScript, selectedSlug || 'mt-horeb');
      }
      doCopy(personalized);
    });

    // --- Preview ---

    function truncateDesc(desc, maxLen) {
      if (!desc) return '';
      if (desc.length <= maxLen) return desc;
      return desc.substring(0, maxLen - 1).trim() + '\u2026';
    }

    function cityFromStoreName(storeName, fallback) {
      if (!storeName) return fallback || '';
      var ofMatch = storeName.match(/of\s+(.+?)(?:,|\s*-)/);
      if (ofMatch) return ofMatch[1].trim();
      var commaMatch = storeName.match(/^(.+?),/);
      if (commaMatch) return commaMatch[1].trim();
      return fallback || storeName;
    }

    async function loadPreview(slug) {
      if (typeof loadFlavorColors === 'function') {
        try { await loadFlavorColors(); } catch (e) { /* best effort */ }
      }

      try {
        var todayResp = await fetch(WORKER_BASE + '/api/v1/today?slug=' + encodeURIComponent(slug));
        if (todayResp.ok) {
          var today = await todayResp.json();
          document.getElementById('preview-flavor').textContent = today.flavor || 'No flavor';
          document.getElementById('preview-date').textContent = formatDateLabel(today.date);

          var descEl = document.getElementById('preview-desc');
          descEl.textContent = truncateDesc(today.description, 80);

          var coneEl = document.getElementById('preview-cone');
          if (typeof renderMiniConeSVG === 'function' && today.flavor) {
            coneEl.innerHTML = renderMiniConeSVG(today.flavor, 6);
          }

          var rarityEl = document.getElementById('preview-rarity');
          rarityEl.textContent = (today.rarity && today.rarity.label) ? today.rarity.label.toUpperCase() : '';

          var brandKey = today.brand || "Culver's";
          var brandColors = {
            "Culver's": { bg: '#005696', text: '#fff' },
            "Kopp's":   { bg: '#1a1a1a', text: '#fff' },
            "Gille's":  { bg: '#EBCC35', text: '#1a1a1a' },
            "Hefner's": { bg: '#93BE46', text: '#1a1a1a' },
            "Kraverz":  { bg: '#CE742D', text: '#fff' },
            "Oscar's":  { bg: '#BC272C', text: '#fff' }
          };
          var bc = brandColors[brandKey] || brandColors["Culver's"];
          var city = cityFromStoreName(today.store, slug);

          var smallHeader = document.getElementById('small-header');
          smallHeader.style.background = bc.bg;
          smallHeader.style.color = bc.text;
          document.getElementById('preview-location').textContent = city;

          var medHeader = document.getElementById('medium-header');
          medHeader.style.background = bc.bg;
          medHeader.style.color = bc.text;
          document.getElementById('preview-location-med').textContent = city;
        }

        var flavorsResp = await fetch(WORKER_BASE + '/api/v1/flavors?slug=' + encodeURIComponent(slug));
        if (flavorsResp.ok) {
          var data = await flavorsResp.json();
          var todayStr = new Date().toISOString().slice(0, 10);
          var upcoming = (data.flavors || []).filter(function(f) { return f.date >= todayStr; }).slice(0, 3);
          var rowsEl = document.getElementById('preview-rows');
          rowsEl.innerHTML = '';
          for (var i = 0; i < upcoming.length; i++) {
            var card = document.createElement('div');
            card.className = 'flavor-card';
            var coneSvg = (typeof renderMiniConeSVG === 'function') ? renderMiniConeSVG(upcoming[i].title, 4) : '';
            var descHtml = upcoming[i].description
              ? '<div class="fdesc">' + escapeHtml(truncateDesc(upcoming[i].description, 70)) + '</div>'
              : '';
            card.innerHTML = '<span class="cone-icon">' + coneSvg + '</span>'
              + '<div class="card-text">'
              + '<div class="day">' + formatDateLabel(upcoming[i].date) + '</div>'
              + '<div class="fname">' + escapeHtml(upcoming[i].title) + '</div>'
              + descHtml
              + '</div>';
            rowsEl.appendChild(card);
          }
        }
      } catch (err) {
        document.getElementById('preview-flavor').textContent = 'Preview unavailable';
      }
    }

    async function loadMultiPreview() {
      if (typeof loadFlavorColors === 'function') {
        try { await loadFlavorColors(); } catch (e) { /* best effort */ }
      }

      var slugs = [primarySlug, backup1Slug, backup2Slug];
      var rowsEl = document.getElementById('preview-multi-rows');
      if (!rowsEl) return;

      var results = await Promise.all(slugs.map(async function(s) {
        if (!s) return null;
        try {
          var resp = await fetch(WORKER_BASE + '/api/v1/today?slug=' + encodeURIComponent(s));
          if (resp.ok) return await resp.json();
          return null;
        } catch(e) { return null; }
      }));

      rowsEl.innerHTML = '';
      for (var i = 0; i < 3; i++) {
        var data = results[i];
        var rowSlug = slugs[i];
        var row = document.createElement('div');
        row.className = 'multi-row';

        var city = data ? cityFromStoreName(data.store, rowSlug) : (rowSlug ? rowSlug.replace(/-/g, ' ') : '');
        var coneSvg = (typeof renderMiniConeSVG === 'function' && data && data.flavor)
          ? renderMiniConeSVG(data.flavor, 4)
          : '';
        var flavorName = data ? (data.flavor || 'TBD') : (rowSlug ? 'Loading\u2026' : '\u2014');
        var rarityHtml = (data && data.rarity && data.rarity.label)
          ? '<span class="mr-rarity">' + escapeHtml(data.rarity.label.toUpperCase()) + '</span>'
          : '';

        row.innerHTML = '<span class="cone-icon">' + coneSvg + '</span>'
          + '<span class="mr-city">' + escapeHtml(city) + '</span>'
          + '<span class="mr-flavor">' + escapeHtml(flavorName) + '</span>'
          + rarityHtml;
        rowsEl.appendChild(row);
      }
    }

    function formatDateLabel(dateStr) {
      if (!dateStr) return '';
      var d = new Date(dateStr + 'T12:00:00');
      var today = new Date(); today.setHours(12, 0, 0, 0);
      var tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);
      if (d.toDateString() === today.toDateString()) return 'Today';
      if (d.toDateString() === tomorrow.toDateString()) return 'Tomorrow';
      return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    }

    var escapeHtml = CustardPlanner.escapeHtml;

    loadStores();

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(function() {});
    }
  </script>
</body>
</html>
