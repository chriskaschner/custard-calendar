<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flavor Asset Parity Audit</title>
<style>
  :root {
    --bg: #0e1117; --surface: #1a1f2e; --surface2: #242938;
    --border: #2e3548; --text: #e8eaf0; --muted: #8892aa;
    --accent: #005696;
    --ok: #1e4d36; --warn: #4d3c1e; --err: #4d1e1e; --info: #1e304d;
    --ok-t: #6dd49b; --warn-t: #e6b84f; --err-t: #f28b82; --info-t: #80b4e6;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; font-size: 14px; line-height: 1.5; }

  header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 12px 24px; display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
  header h1 { font-size: 17px; font-weight: 600; white-space: nowrap; }
  #stat-bar { display: flex; gap: 14px; flex-wrap: wrap; font-size: 12px; }
  .stat { color: var(--muted); }
  .stat b { font-weight: 700; }
  .stat.ok b { color: var(--ok-t); }
  .stat.warn b { color: var(--warn-t); }
  .stat.err b { color: var(--err-t); }
  #api-note { font-size: 11px; color: var(--muted); margin-left: auto; }

  main { padding: 18px 24px; max-width: 1440px; margin: 0 auto; }
  section { margin-bottom: 32px; }
  h2 { font-size: 11px; font-weight: 700; letter-spacing: .08em; text-transform: uppercase; color: var(--muted); border-bottom: 1px solid var(--border); padding-bottom: 6px; margin-bottom: 14px; }

  /* Collision pairs */
  .col-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px,1fr)); gap: 10px; }
  .col-pair { background: var(--warn); border: 1px solid #7d5c2e; border-radius: 6px; padding: 12px; }
  .col-pair h3 { font-size: 11px; font-weight: 700; color: var(--warn-t); margin-bottom: 10px; letter-spacing: .04em; text-transform: uppercase; }
  .col-sides { display: flex; gap: 10px; }
  .col-side { flex: 1; background: var(--surface); border-radius: 4px; padding: 8px; display: flex; flex-direction: column; align-items: center; gap: 5px; }
  .col-side .cname { font-size: 12px; font-weight: 500; text-align: center; }
  .col-side .cwhere { font-size: 10px; color: var(--muted); text-align: center; line-height: 1.3; }

  /* Filter bar */
  .fbar { display: flex; gap: 10px; margin-bottom: 12px; align-items: center; flex-wrap: wrap; }
  .fbar input[type=text] { background: var(--surface); border: 1px solid var(--border); color: var(--text); border-radius: 4px; padding: 5px 10px; font-size: 13px; width: 180px; }
  .fbar input[type=text]::placeholder { color: var(--muted); }
  .fbar label { font-size: 12px; color: var(--muted); display: flex; align-items: center; gap: 5px; cursor: pointer; white-space: nowrap; }
  #fcount { font-size: 12px; color: var(--muted); margin-left: auto; }

  /* Col headers */
  .ch { display: grid; grid-template-columns: 180px 58px 65px 72px 94px 148px 148px 220px 1fr; padding: 0 10px; margin-bottom: 6px; }
  .ch span { font-size: 10px; color: var(--muted); font-weight: 700; text-align: center; line-height: 1.3; }
  .ch span:first-child { text-align: left; }

  /* Rows */
  .fgrid { display: flex; flex-direction: column; gap: 3px; }
  .frow {
    display: grid;
    grid-template-columns: 180px 58px 65px 72px 94px 148px 148px 220px 1fr;
    align-items: center;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 5px;
    overflow: hidden;
  }
  .frow:hover { border-color: #3e4a65; }
  .frow.s-warn { border-color: #7d5c2e; background: #130d04; }
  .frow.s-info { border-color: #1e4a7d; background: #040a13; }

  .c { padding: 8px 10px; display: flex; align-items: center; justify-content: center; border-right: 1px solid var(--border); min-height: 72px; }
  .c:last-child { border-right: none; }
  .c-name { justify-content: flex-start; flex-direction: column; align-items: flex-start; gap: 3px; }
  .c-meta { flex-direction: column; align-items: flex-start; gap: 5px; padding: 8px 12px; }

  .ftitle { font-weight: 500; font-size: 13px; }
  .fdesc { font-size: 10px; color: var(--muted); max-width: 190px; line-height: 1.3; }
  .badge { font-size: 10px; padding: 1px 6px; border-radius: 3px; white-space: nowrap; }
  .b-ok      { background: var(--ok);   color: var(--ok-t); }
  .b-warn    { background: var(--warn); color: var(--warn-t); }
  .b-err     { background: var(--err);  color: var(--err-t); }
  .b-info    { background: var(--info); color: var(--info-t); }
  .b-changed { background: #2a1a3e; color: #c084fc; }

  .c-before { position: relative; flex-direction: column; gap: 4px; }
  .c-before .badge { position: absolute; top: 4px; right: 4px; }

  /* Map marker */
  .mw { width: 46px; height: 54px; display: flex; align-items: flex-start; justify-content: center; }
  .mp { border-radius: 50% 50% 50% 0; transform: rotate(-45deg); width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; border: 2px solid; background: var(--surface2); }
  .mp svg { transform: rotate(45deg); }

  /* Swatches */
  .swr { display: flex; gap: 4px; flex-wrap: wrap; }
  .sw { width: 18px; height: 18px; border-radius: 3px; border: 1px solid rgba(255,255,255,.1); }
  .swg { display: flex; flex-direction: column; gap: 2px; align-items: center; }
  .swl { font-size: 9px; color: var(--muted); text-align: center; max-width: 36px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .mtags { display: flex; gap: 4px; flex-wrap: wrap; }
  .mt { font-size: 10px; padding: 1px 6px; border-radius: 3px; background: var(--surface2); color: var(--muted); border: 1px solid var(--border); white-space: nowrap; }
  .mt.d-standard { color: var(--info-t); }
  .mt.d-double   { color: var(--ok-t); }
  .mt.d-explosion { color: var(--warn-t); }
  .mt.d-overload  { color: var(--err-t); }
  .mt.d-pure      { color: #aaa; }

  .noprof { color: var(--err-t); font-size: 11px; max-width: 180px; line-height: 1.4; }

  /* Tidbyt pixel zoom */
  .tidbyt-wrap { display: flex; align-items: center; justify-content: center; width: 45px; height: 55px; }
  .tidbyt-inner { image-rendering: pixelated; image-rendering: crisp-edges; transform-origin: top left; }

  /* Map dual-bg */
  .map-pair { display: flex; flex-direction: column; gap: 4px; align-items: center; }
  .map-bg-d { background: var(--surface2); padding: 3px; border-radius: 3px; }
  .map-bg-l { background: #e8edf5; padding: 3px; border-radius: 3px; }

  /* Resolved collisions details block */
  .col-resolved { margin-top: 10px; }
  .col-resolved summary { font-size: 11px; font-weight: 700; letter-spacing: .06em; text-transform: uppercase; color: var(--muted); cursor: pointer; padding: 6px 0; user-select: none; }
  .col-resolved summary:hover { color: var(--text); }
  .col-resolved[open] summary { color: var(--text); margin-bottom: 10px; }
  .col-none { font-size: 12px; color: var(--muted); padding: 8px 0; }

  /* Quality flags */
  .qflags { display: flex; flex-direction: column; gap: 3px; }
  .qf { font-size: 9px; padding: 1px 5px; border-radius: 3px; white-space: nowrap; }
  .qf-warn { background: var(--warn); color: var(--warn-t); }
  .qf-info { background: var(--info); color: var(--info-t); }
  .qf-err  { background: var(--err);  color: var(--err-t); }
</style>
</head>
<body>
<header>
  <h1>Flavor Asset Parity Audit</h1>
  <div id="stat-bar">
    <span class="stat ok"><b id="s-prof">0</b> profiles</span>
    <span class="stat ok"><b id="s-cat">0</b> catalog</span>
    <span class="stat ok"><b id="s-ok">0</b> aligned</span>
    <span class="stat warn"><b id="s-warn">0</b> no profile</span>
    <span class="stat err"><b id="s-info">0</b> profile-only</span>
    <span class="stat warn"><b id="s-flagged">0</b> quality flags</span>
  </div>
  <span id="api-note">seed data — try the live API for updated catalog</span>
</header>
<main>

<section>
  <h2>Active collisions — same flavor, different names across surfaces</h2>
  <div class="col-grid" id="col-grid-active"></div>
  <p class="col-none" id="col-none" style="display:none">No active collisions detected.</p>
  <details class="col-resolved" id="col-resolved-wrap">
    <summary id="col-resolved-summary">Resolved investigations (0)</summary>
    <div class="col-grid" id="col-grid-resolved"></div>
  </details>
</section>

<section>
  <h2>All flavors — catalog + profiles unified</h2>
  <div class="fbar">
    <input type="text" id="search" placeholder="Filter flavors...">
    <label><input type="checkbox" id="f-ok" checked> Aligned</label>
    <label><input type="checkbox" id="f-warn" checked> No profile</label>
    <label><input type="checkbox" id="f-info" checked> Profile-only</label>
    <label><input type="checkbox" id="f-flagged" checked> Flagged</label>
    <span id="fcount"></span>
  </div>
  <div class="ch">
    <span style="text-align:left">Flavor + description</span>
    <span>Tidbyt<br>px ×1→6</span>
    <span>Widget<br>mini ×5</span>
    <span>Map<br>dark/light</span>
    <span>Radar<br>HD ×5</span>
    <span>Before<br>HD ×8</span>
    <span>Hero / OG<br>HD ×8</span>
    <span>Premium ×6<br>24x28 scatter</span>
    <span>Quality + Colors</span>
  </div>
  <div class="fgrid" id="fgrid"></div>
</section>

</main>
<script>
// ---------------------------------------------------------------------------
// Embedded seed data (from worker/src/flavor-colors.js + flavor-catalog.js)
// Page works fully offline; API calls upgrade to live data if available.
// ---------------------------------------------------------------------------
// Snapshot of profiles BEFORE the spec-driven update (2026-02-26).
// Used by the "Before" HD×8 column in the audit grid for comparison.
var LEGACY_PROFILES = {
  'dark chocolate pb crunch':    { base:'dark_chocolate',    ribbon:'peanut_butter',   toppings:['butterfinger'],                        density:'standard' },
  'chocolate caramel twist':     { base:'chocolate',         ribbon:'caramel',         toppings:['dove'],                               density:'standard' },
  'mint explosion':              { base:'mint',              ribbon:null,              toppings:['oreo','andes','dove'],                 density:'explosion' },
  'turtle dove':                 { base:'vanilla',           ribbon:'marshmallow',     toppings:['pecan','dove'],                       density:'standard' },
  'double strawberry':           { base:'strawberry',        ribbon:null,              toppings:['strawberry_bits'],                    density:'double' },
  'turtle cheesecake':           { base:'cheesecake',        ribbon:'caramel',         toppings:['dove','pecan','cheesecake_bits'],      density:'explosion' },
  'caramel turtle':              { base:'caramel',           ribbon:null,              toppings:['pecan','dove'],                       density:'standard' },
  'andes mint avalanche':        { base:'mint_andes',        ribbon:null,              toppings:['andes','andes','dove'],               density:'standard' },
  'oreo cookie cheesecake':      { base:'cheesecake',        ribbon:null,              toppings:['oreo','cheesecake_bits'],             density:'standard' },
  "devil's food cake":           { base:'dark_chocolate',    ribbon:null,              toppings:['cake','dove'],                        density:'standard' },
  'caramel cashew':              { base:'vanilla',           ribbon:'caramel',         toppings:['cashew'],                             density:'standard' },
  'butter pecan':                { base:'butter_pecan',      ribbon:null,              toppings:['pecan'],                              density:'standard' },
  'caramel chocolate pecan':     { base:'chocolate_custard', ribbon:'caramel',         toppings:['pecan','pecan','dove','pecan'],        density:'explosion' },
  'dark chocolate decadence':    { base:'dark_chocolate',    ribbon:null,              toppings:[],                                     density:'pure' },
  'caramel fudge cookie dough':  { base:'vanilla',           ribbon:'fudge',           toppings:['cookie_dough'],                       density:'standard' },
  'mint cookie':                 { base:'mint',              ribbon:null,              toppings:['oreo'],                               density:'double' },
  'caramel pecan':               { base:'caramel',           ribbon:null,              toppings:['pecan'],                              density:'standard' },
  "really reese's":              { base:'chocolate',         ribbon:'peanut_butter',   toppings:['reeses'],                             density:'standard' },
  'raspberry cheesecake':        { base:'cheesecake',        ribbon:null,              toppings:['raspberry','cheesecake_bits'],         density:'standard' },
  'chocolate covered strawberry':{ base:'vanilla',           ribbon:null,              toppings:['strawberry_bits','dove'],             density:'standard' },
  'caramel peanut buttercup':    { base:'vanilla',           ribbon:'peanut_butter',   toppings:['dove'],                               density:'standard' },
  'turtle':                      { base:'vanilla',           ribbon:'caramel',         toppings:['dove','pecan'],                       density:'standard' },
  'georgia peach':               { base:'peach',             ribbon:null,              toppings:['peach_bits'],                         density:'standard' },
  'snickers swirl':              { base:'chocolate',         ribbon:'caramel',         toppings:['snickers'],                           density:'standard' },
  'chocolate volcano':           { base:'chocolate',         ribbon:'chocolate_syrup', toppings:['oreo','dove','m_and_m'],              density:'explosion' },
  'oreo cookie overload':        { base:'chocolate',         ribbon:'chocolate_syrup', toppings:['oreo'],                               density:'overload' },
  'salted double caramel pecan': { base:'vanilla',           ribbon:'caramel',         toppings:['pecan','salt'],                       density:'double' },
  'crazy for cookie dough':      { base:'vanilla',           ribbon:'fudge',           toppings:['cookie_dough'],                       density:'standard' },
  'chocolate heath crunch':      { base:'chocolate',         ribbon:null,              toppings:['heath'],                              density:'standard' },
  'double butter pecan':         { base:'vanilla',           ribbon:null,              toppings:['pecan'],                              density:'double' },
  'blackberry cobbler':          { base:'blackberry',        ribbon:null,              toppings:['pie_crust','pie_crust','pie_crust'],  density:'standard' },
  'brownie thunder':             { base:'chocolate',         ribbon:'marshmallow',     toppings:['brownie'],                            density:'standard' },
  'chocolate oreo volcano':      { base:'chocolate',         ribbon:'marshmallow',     toppings:['oreo','dove'],                        density:'explosion' },
  'lemon berry layer cake':      { base:'lemon',             ribbon:null,              toppings:['blueberry','cake'],                   density:'standard' },
  'lemon dash cookie':           { base:'lemon',             ribbon:null,              toppings:['oreo'],                               density:'standard' },
  'oreo cheesecake':             { base:'cheesecake',        ribbon:null,              toppings:['oreo','cheesecake_bits'],             density:'standard' },
  'peanut butter cup':           { base:'chocolate',         ribbon:'peanut_butter',   toppings:['reeses'],                             density:'standard' },
  'salted caramel pecan pie':    { base:'caramel',           ribbon:null,              toppings:['pecan','salt','pie_crust'],           density:'explosion' },
  'strawberry cheesecake':       { base:'cheesecake',        ribbon:null,              toppings:['strawberry_bits','cheesecake_bits'],  density:'standard' },
  'vanilla':                     { base:'vanilla',           ribbon:null,              toppings:[],                                     density:'pure' },
};

// Current profiles — synced with worker/src/flavor-colors.js (post spec-driven update)
var SEED_PROFILES = {
  'dark chocolate pb crunch':    { base:'dark_chocolate',    ribbon:'peanut_butter',   toppings:['butterfinger'],                        density:'standard' },
  'chocolate caramel twist':     { base:'chocolate',         ribbon:'caramel',         toppings:['dove'],                               density:'standard' },
  'mint explosion':              { base:'mint',              ribbon:null,              toppings:['oreo','andes','dove'],                 density:'explosion' },
  'turtle dove':                 { base:'vanilla',           ribbon:'marshmallow',     toppings:['pecan','dove'],                       density:'standard' },
  'double strawberry':           { base:'strawberry',        ribbon:null,              toppings:['strawberry_bits'],                    density:'double' },
  'turtle cheesecake':           { base:'cheesecake',        ribbon:'caramel',         toppings:['pecan','dove','pecan'],               density:'explosion' },
  'caramel turtle':              { base:'caramel',           ribbon:'fudge',           toppings:['pecan','dove','pecan'],               density:'explosion' },
  'andes mint avalanche':        { base:'mint_andes',        ribbon:null,              toppings:['andes','andes','dove'],               density:'standard' },
  'oreo cookie cheesecake':      { base:'cheesecake',        ribbon:null,              toppings:['oreo'],                               density:'double' },
  "devil's food cake":           { base:'chocolate_custard', ribbon:null,              toppings:['cake','dove'],                        density:'standard' },
  'caramel cashew':              { base:'vanilla',           ribbon:'caramel',         toppings:['cashew'],                             density:'standard' },
  'butter pecan':                { base:'butter_pecan',      ribbon:null,              toppings:['pecan'],                              density:'standard' },
  'caramel chocolate pecan':     { base:'chocolate_custard', ribbon:'caramel',         toppings:['pecan','pecan','dove','pecan'],        density:'explosion' },
  'dark chocolate decadence':    { base:'dark_chocolate',    ribbon:null,              toppings:[],                                     density:'pure' },
  'caramel fudge cookie dough':  { base:'vanilla',           ribbon:'fudge',           toppings:['cookie_dough'],                       density:'standard' },
  'mint cookie':                 { base:'mint',              ribbon:null,              toppings:['oreo'],                               density:'double' },
  'caramel pecan':               { base:'caramel',           ribbon:null,              toppings:['pecan'],                              density:'standard' },
  "really reese's":              { base:'chocolate',         ribbon:'peanut_butter',   toppings:['reeses'],                             density:'standard' },
  'raspberry cheesecake':        { base:'cheesecake',        ribbon:null,              toppings:['raspberry'],                          density:'double' },
  'chocolate covered strawberry':{ base:'vanilla',           ribbon:null,              toppings:['strawberry_bits','dove'],             density:'standard' },
  'caramel peanut buttercup':    { base:'vanilla',           ribbon:'peanut_butter',   toppings:['dove'],                               density:'standard' },
  'turtle':                      { base:'vanilla',           ribbon:'caramel',         toppings:['pecan','dove'],                       density:'standard' },
  'georgia peach':               { base:'peach',             ribbon:null,              toppings:['peach_bits'],                         density:'standard' },
  'snickers swirl':              { base:'chocolate',         ribbon:'caramel',         toppings:['snickers'],                           density:'standard' },
  'chocolate volcano':           { base:'chocolate',         ribbon:'chocolate_syrup', toppings:['oreo','dove','m_and_m'],              density:'explosion' },
  'oreo cookie overload':        { base:'chocolate',         ribbon:'chocolate_syrup', toppings:['oreo'],                               density:'overload' },
  'salted double caramel pecan': { base:'vanilla',           ribbon:'caramel',         toppings:['pecan','salt'],                       density:'double' },
  'crazy for cookie dough':      { base:'vanilla',           ribbon:'fudge',           toppings:['cookie_dough'],                       density:'standard' },
  'chocolate heath crunch':      { base:'chocolate',         ribbon:null,              toppings:['heath'],                              density:'standard' },
  'double butter pecan':         { base:'vanilla',           ribbon:null,              toppings:['pecan'],                              density:'double' },
  'blackberry cobbler':          { base:'blackberry',        ribbon:null,              toppings:['pie_crust','pie_crust','pie_crust'],  density:'standard' },
  'brownie thunder':             { base:'chocolate',         ribbon:'marshmallow',     toppings:['brownie','dove','brownie'],            density:'explosion' },
  'chocolate oreo volcano':      { base:'chocolate',         ribbon:'marshmallow',     toppings:['oreo','dove'],                        density:'explosion' },
  'lemon berry layer cake':      { base:'lemon',             ribbon:null,              toppings:['blueberry','cake'],                   density:'standard' },
  'lemon dash cookie':           { base:'lemon',             ribbon:null,              toppings:['oreo'],                               density:'standard' },
  'oreo cheesecake':             { base:'cheesecake',        ribbon:null,              toppings:['oreo'],                               density:'double' },
  'peanut butter cup':           { base:'chocolate',         ribbon:'peanut_butter',   toppings:['reeses'],                             density:'standard' },
  'salted caramel pecan pie':    { base:'caramel',           ribbon:null,              toppings:['pecan','salt','pie_crust'],           density:'explosion' },
  'strawberry cheesecake':       { base:'cheesecake',        ribbon:null,              toppings:['strawberry_bits'],                    density:'double' },
  'vanilla':                     { base:'vanilla',           ribbon:null,              toppings:[],                                     density:'pure' },
};

var SEED_BASE = {
  vanilla:'#F5DEB3', chocolate:'#6F4E37', dark_chocolate:'#3B1F0B',
  mint:'#2ECC71', mint_andes:'#1A8A4A', strawberry:'#FF6B9D',
  cheesecake:'#FFF5E1', caramel:'#C68E17', butter_pecan:'#F2E7D1', peach:'#FFE5B4',
  lemon:'#FFF176', blackberry:'#6B3FA0'
};
var SEED_RIBBON = {
  caramel:'#DAA520', peanut_butter:'#D4A017', marshmallow:'#FFFFFF',
  chocolate_syrup:'#1A0A00', fudge:'#3B1F0B'
};
var SEED_TOPPING = {
  oreo:'#1A1A1A', andes:'#1FAE7A', dove:'#3B1F0B', pecan:'#8B6914',
  cashew:'#D4C4A8', heath:'#DAA520', butterfinger:'#E6A817', cookie_dough:'#C4A882',
  strawberry_bits:'#FF1744', raspberry:'#E91E63', peach_bits:'#FF9800',
  salt:'#FFFFFF', snickers:'#C4A060', cake:'#4A2800', cheesecake_bits:'#FFF8DC',
  m_and_m:'#FF4444', reeses:'#D4A017',
  brownie:'#2D1700', blueberry:'#3B1F6B', pie_crust:'#C4966A'
};
var SEED_CONE = { waffle:'#D2691E', waffle_dark:'#B8860B' };
var CONE_TIP = '#8B5A2B';

var SEED_CATALOG = [
  { title:'Andes Mint Avalanche',         description:'Mint Fresh Frozen Custard with Andes Mint pieces and chocolate.' },
  { title:'Blackberry Cobbler',           description:'Blackberry Fresh Frozen Custard with pie crust pieces.' },
  { title:'Brownie Thunder',              description:'Chocolate Fresh Frozen Custard with brownie pieces and marshmallow.' },
  { title:'Butter Pecan',                 description:'Butter Pecan Fresh Frozen Custard.' },
  { title:'Caramel Cashew',               description:'Vanilla Fresh Frozen Custard with caramel and cashew pieces.' },
  { title:'Caramel Fudge Cookie Dough',   description:'Vanilla Fresh Frozen Custard with caramel, fudge, and cookie dough.' },
  { title:'Caramel Pecan',                description:'Caramel Fresh Frozen Custard with pecan pieces.' },
  { title:'Caramel Turtle',               description:'Caramel Fresh Frozen Custard with pecan pieces and fudge.' },
  { title:'Chocolate Caramel Twist',      description:'Chocolate and Vanilla Fresh Frozen Custard with caramel.' },
  { title:'Chocolate Heath Crunch',       description:'Chocolate Fresh Frozen Custard with Heath bar pieces.' },
  { title:'Chocolate Oreo Volcano',       description:'Chocolate Fresh Frozen Custard with OREO cookie pieces and marshmallow.', historical:true },
  { title:'Chocolate Volcano',            description:'Chocolate Fresh Frozen Custard with fudge and marshmallow.' },
  { title:'Crazy for Cookie Dough',       description:'Vanilla Fresh Frozen Custard with cookie dough pieces and fudge.' },
  { title:'Dark Chocolate Decadence',     description:'Dark Chocolate Fresh Frozen Custard with fudge and chocolate chips.' },
  { title:'Dark Chocolate PB Crunch',     description:'Dark Chocolate Fresh Frozen Custard with peanut butter and chocolate crunch.' },
  { title:'Lemon Berry Layer Cake',       description:'Lemon Fresh Frozen Custard with blueberries and cake pieces.' },
  { title:'Lemon Dash Cookie',            description:'Lemon Fresh Frozen Custard with cookie pieces.' },
  { title:'Mint Cookie',                  description:'Mint Fresh Frozen Custard with cookie pieces.' },
  { title:'Mint Explosion',               description:'Mint Fresh Frozen Custard with OREO cookie pieces and fudge.' },
  { title:'OREO Cheesecake',              description:'Cheesecake Fresh Frozen Custard with OREO cookie pieces.' },
  { title:'OREO Cookie Cheesecake',       description:'Cheesecake Fresh Frozen Custard with OREO cookie pieces.' },
  { title:'Peanut Butter Cup',            description:"Chocolate Fresh Frozen Custard with peanut butter cup pieces. Culver's name through 2021; now called Really Reese's.", historical:true },
  { title:'Raspberry Cheesecake',         description:'Cheesecake Fresh Frozen Custard with raspberry sauce.' },
  { title:"Really Reese's",               description:"Chocolate Fresh Frozen Custard with Reese's peanut butter cup pieces." },
  { title:'Salted Caramel Pecan Pie',     description:'Salted Caramel Fresh Frozen Custard with pecan pie pieces.', historical:true },
  { title:'Snickers Swirl',               description:'Chocolate Fresh Frozen Custard with Snickers bar pieces and caramel.' },
  { title:'Strawberry Cheesecake',        description:'Cheesecake Fresh Frozen Custard with strawberry sauce.' },
  { title:'Turtle',                       description:'Vanilla Fresh Frozen Custard with pecan pieces, caramel, and fudge.' },
  { title:'Turtle Cheesecake',            description:'Cheesecake Fresh Frozen Custard with pecan pieces, caramel, and fudge.' },
  { title:'Turtle Dove',                  description:'Chocolate and Vanilla Fresh Frozen Custard with pecan pieces, caramel, and fudge.' },
  { title:'Vanilla',                      description:'Vanilla Fresh Frozen Custard.' },
];

var COLLISIONS = [
  // resolved: true = investigation complete, verdict documented
  { resolved:true, label:'Chocolate Volcano / Chocolate Oreo Volcano',
    verdict:'Distinct flavors — no same-day co-occurrence at any store. Chocolate Oreo Volcano retired July 2023; tagged historical.',
    a:{ name:'Chocolate Volcano',       has_profile:true, where:'active — profile + catalog' },
    b:{ name:'Chocolate Oreo Volcano',  has_profile:true, where:'historical — profile + catalog (retired 2023)' } },
  { resolved:true, label:'Salted Double Caramel Pecan / Salted Caramel Pecan Pie',
    verdict:'Distinct flavors — no same-day co-occurrence. Salted Caramel Pecan Pie last seen March 2025; tagged historical.',
    a:{ name:'Salted Double Caramel Pecan', has_profile:true, where:'active — profile + catalog' },
    b:{ name:'Salted Caramel Pecan Pie',    has_profile:true, where:'historical — profile + catalog (last 2025-03)' } },
  { resolved:true, label:'OREO Cookie Cheesecake / OREO Cheesecake',
    verdict:'Distinct flavors — no same-day co-occurrence. OREO Cheesecake is current Gille\'s name; OREO Cookie Cheesecake is current Culver\'s name.',
    a:{ name:'OREO Cookie Cheesecake',  has_profile:true, where:'active Culver\'s name — profile + catalog' },
    b:{ name:'OREO Cheesecake',         has_profile:true, where:'active Gille\'s name — profile + catalog' } },
  { resolved:true, label:"Really Reese's / Peanut Butter Cup",
    verdict:"Same product — Culver's called it Peanut Butter Cup through April 2021, then renamed to Really Reese's. 80 stores, zero same-day overlap. PB Cup tagged historical.",
    a:{ name:"Really Reese's",          has_profile:true, where:"active Culver's name — profile + catalog" },
    b:{ name:'Peanut Butter Cup',       has_profile:true, where:"historical — profile + catalog (retired 2021)" } },
];

// ---------------------------------------------------------------------------
// Live state (starts as seed, upgrades if API responds)
// ---------------------------------------------------------------------------
var colorData = {
  profiles: SEED_PROFILES,
  base_colors: SEED_BASE,
  ribbon_colors: SEED_RIBBON,
  topping_colors: SEED_TOPPING,
  cone_colors: SEED_CONE,
};

// ---------------------------------------------------------------------------
// Rendering helpers
// ---------------------------------------------------------------------------
function nfk(n) { return String(n||'').toLowerCase().replace(/[\u00ae\u2122]/g,'').replace(/[\u2018\u2019]/g,"'").replace(/\s+/g,' ').trim(); }
function getP(name) { var k=nfk(name); return (colorData.profiles||{})[k]||null; }
function bCol(name) {
  var k=nfk(name), p=getP(name), bc=colorData.base_colors||{};
  if(p&&bc[p.base]) return bc[p.base];
  if(k.includes('mint')) return bc.mint||SEED_BASE.mint;
  if(k.includes('dark choc')) return bc.dark_chocolate||SEED_BASE.dark_chocolate;
  if(k.includes('chocolate')||k.includes('cocoa')) return bc.chocolate||SEED_BASE.chocolate;
  if(k.includes('strawberry')) return bc.strawberry||SEED_BASE.strawberry;
  if(k.includes('cheesecake')) return bc.cheesecake||SEED_BASE.cheesecake;
  if(k.includes('caramel')) return bc.caramel||SEED_BASE.caramel;
  if(k.includes('peach')) return bc.peach||SEED_BASE.peach;
  if(k.includes('butter pecan')) return bc.butter_pecan||SEED_BASE.butter_pecan;
  if(k.includes('lemon')) return bc.lemon||SEED_BASE.lemon||'#FFF176';
  if(k.includes('blackberry')) return bc.blackberry||SEED_BASE.blackberry||'#6B3FA0';
  return bc.vanilla||SEED_BASE.vanilla;
}
function lh(hex,a) { var r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16); return '#'+[r,g,b].map(function(c){return Math.round(c+(255-c)*a).toString(16).padStart(2,'0');}).join('').toUpperCase(); }
function dk(hex,a) { var r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16); return '#'+[r,g,b].map(function(c){return Math.round(c*(1-a)).toString(16).padStart(2,'0');}).join('').toUpperCase(); }
function R(x,y,w,h,f) { return '<rect x="'+x+'" y="'+y+'" width="'+w+'" height="'+h+'" fill="'+f+'"/>'; }

function miniCone(name,s) {
  s=s||5;
  var p=getP(name), bc=colorData.base_colors||{}, tc=colorData.topping_colors||{}, rc=colorData.ribbon_colors||{}, cc=colorData.cone_colors||SEED_CONE;
  var b=(p&&bc[p.base])?bc[p.base]:bCol(name), rk=p?p.ribbon:null, rCol=rk?(rc[rk]||SEED_RIBBON[rk]||null):null;
  var den=p?p.density:'standard', tops=p?(p.toppings||[]):[], ts;
  if(den==='pure') ts=[];
  else if(den==='double'){ts=tops.length?[tops[0],tops[0]]:[];if(tops.length>1)ts.push(tops[1]);}
  else if(den==='explosion') ts=tops.slice(0,4);
  else ts=tops.slice(0,4);
  var o=[];
  [[3,5],[2,6],[1,7],[1,7],[1,7],[2,6]].forEach(function(r,i){for(var c=r[0];c<=r[1];c++)o.push(R(c*s,i*s,s,s,b));});
  var tsl=[[2,1],[6,1],[3,3],[5,2]];
  ts.forEach(function(k,i){if(i===3&&rCol)return;var col=tc[k]||SEED_TOPPING[k];if(!col)return;o.push(R(tsl[i][0]*s,tsl[i][1]*s,s,s,col));});
  if(rCol)[[3,0],[4,1],[5,2]].forEach(function(r){o.push(R(r[0]*s,r[1]*s,s,s,rCol));});
  [[2,6],[2,6],[3,5],[3,5]].forEach(function(r,cr){for(var c=r[0];c<=r[1];c++){var wc=((cr+c)%2===0)?cc.waffle:cc.waffle_dark;o.push(R(c*s,(cr+6)*s,s,s,wc));}});
  o.push(R(4*s,10*s,s,s,cc.waffle_dark));
  return '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 '+(9*s)+' '+(11*s)+'" width="'+(9*s)+'" height="'+(11*s)+'" shape-rendering="crispEdges">'+o.join('')+'</svg>';
}

function hdCone(name,s) {
  s=s||5;
  var p=getP(name), bc=colorData.base_colors||{}, tc=colorData.topping_colors||{}, rc=colorData.ribbon_colors||{}, cc=colorData.cone_colors||SEED_CONE;
  var b=(p&&bc[p.base])?bc[p.base]:bCol(name), rk=p?p.ribbon:null, rCol=rk?(rc[rk]||SEED_RIBBON[rk]||null):null;
  var den=p?p.density:'standard', tops=p?(p.toppings||[]):[], ts;
  if(den==='pure') ts=[];
  else if(den==='double'){var pr=tops[0],se=tops[1]||pr;ts=pr?[pr,pr,se,pr,se,pr,se]:[];}
  else if(den==='explosion'){ts=[];for(var i=0;i<8;i++)ts.push(tops[i%tops.length]||tops[0]);}
  else if(den==='overload') ts=tops.length?[tops[0],tops[0],tops[0],tops[0],tops[0],tops[0]]:[];
  else{ts=[];for(var si=0;si<6;si++)ts.push(tops[si%tops.length]||tops[0]);}
  var hl=lh(b,0.3),o=[];
  [[4,13],[3,14],[2,15],[2,15],[2,15],[2,15],[2,15],[2,15],[2,15],[2,15],[3,14],[4,13]].forEach(function(r,i){for(var c=r[0];c<=r[1];c++)o.push(R(c*s,i*s,s,s,b));});
  [[4,0],[3,1]].forEach(function(h){o.push(R(h[0]*s,h[1]*s,s,s,hl));});
  var tsl=[[4,2],[12,1],[6,3],[14,5],[3,6],[11,7],[5,9],[13,8]];
  ts.forEach(function(k,i){var col=tc[k]||SEED_TOPPING[k];if(!col)return;o.push(R(tsl[i][0]*s,tsl[i][1]*s,s,s,col));});
  if(rCol)[[7,1],[8,3],[9,4],[10,5],[9,7],[8,9]].forEach(function(r){o.push(R(r[0]*s,r[1]*s,s,s,rCol));});
  [[4,13],[4,13],[5,12],[5,12],[6,11],[6,11],[7,10],[7,10],[8,9]].forEach(function(r,cr){for(var c=r[0];c<=r[1];c++){var wc=((cr+c)%2===0)?cc.waffle:cc.waffle_dark;o.push(R(c*s,(cr+12)*s,s,s,wc));}});
  o.push(R(8*s,21*s,s,s,CONE_TIP));o.push(R(9*s,21*s,s,s,CONE_TIP));
  return '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 '+(18*s)+' '+(22*s)+'" width="'+(18*s)+'" height="'+(22*s)+'" shape-rendering="crispEdges">'+o.join('')+'</svg>';
}

// Hero cone renderer v2 -- mirrors renderConeHeroSVG in worker/src/flavor-colors.js
// Grid: 36x42px. Fixed topping slots, 4-pixel specular highlight, 9-point ribbon.
var _HSR=[[8,27],[6,29],[4,31],[4,31],[4,31],[4,31],[4,31],[4,31],[4,31],[4,31],[4,31],[4,31],[4,31],[4,31],[4,31],[4,31],[4,31],[4,31],[4,31],[4,31],[6,29],[7,28]];
var _HCR=[[7,28],[7,28],[9,26],[9,26],[11,24],[11,24],[13,22],[13,22],[14,21],[14,21],[15,20],[15,20],[16,19],[16,19],[16,19],[16,19],[17,18],[17,18]];
var _HHL=[[8,0],[9,0],[6,1],[7,1]]; // highlight slots
var _HSH=[[29,19],[28,20],[27,21]]; // shadow slots
var _HTS=[[10,1],[22,3],[8,7],[26,8],[10,12],[24,13],[8,17],[23,18]]; // topping slots (2x2)
var _HRP=[[14,2],[15,4],[16,6],[17,8],[18,10],[17,12],[16,14],[15,16],[16,18]]; // ribbon path
function heroCone(name,s) {
  s=s||4;
  var p=getP(name), bc=colorData.base_colors||{}, tc=colorData.topping_colors||{}, rc=colorData.ribbon_colors||{}, cc=colorData.cone_colors||SEED_CONE;
  var b=(p&&bc[p.base])?bc[p.base]:bCol(name), rk=p?p.ribbon:null, rCol=rk?(rc[rk]||SEED_RIBBON[rk]||null):null;
  var den=p?p.density:'standard', tops=p?(p.toppings||[]):[], ts;
  if(den==='pure') ts=[];
  else if(den==='double'){var pr=tops[0],se=tops[1]||pr;ts=pr?[pr,pr,se,pr,se,pr,se]:[];}
  else if(den==='explosion'){ts=[];for(var i=0;i<8;i++)ts.push(tops[i%tops.length]||tops[0]);}
  else if(den==='overload') ts=tops.length?[tops[0],tops[0],tops[0],tops[0],tops[0],tops[0]]:[];
  else{ts=[];for(var si=0;si<6;si++)ts.push(tops[si%tops.length]||tops[0]);}
  var hl=lh(b,0.25),sh=dk(b,0.12),o=[];
  // 1. Base scoop fill
  _HSR.forEach(function(r,row){for(var col=r[0];col<=r[1];col++)o.push(R(col*s,row*s,s,s,b));});
  // 2. Depth shading: highlight + shadow
  _HHL.forEach(function(pt){o.push(R(pt[0]*s,pt[1]*s,s,s,hl));});
  _HSH.forEach(function(pt){o.push(R(pt[0]*s,pt[1]*s,s,s,sh));});
  // 3. Toppings: fixed 2x2 slots
  for(var i=0;i<ts.length&&i<_HTS.length;i++){
    var col=tc[ts[i]]||SEED_TOPPING[ts[i]]; if(!col) continue;
    o.push(R(_HTS[i][0]*s,_HTS[i][1]*s,2*s,2*s,col));
  }
  // 4. Ribbon: 9-point S-curve, 2px wide
  if(rCol){_HRP.forEach(function(pt){o.push(R(pt[0]*s,pt[1]*s,2*s,s,rCol));});}
  // 5. Cone rows 22-39
  _HCR.forEach(function(r,ri){
    var row=ri+22;
    for(var col=r[0];col<=r[1];col++){var wc=((row+col)%2===0)?cc.waffle:cc.waffle_dark;o.push(R(col*s,row*s,s,s,wc));}
  });
  // 6. Tip rows 40-41
  o.push(R(17*s,40*s,2*s,s,CONE_TIP));o.push(R(17*s,41*s,2*s,s,CONE_TIP));
  return '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 '+(36*s)+' '+(42*s)+'" width="'+(36*s)+'" height="'+(42*s)+'" shape-rendering="crispEdges">'+o.join('')+'</svg>';
}

// Premium cone renderer -- mirrors renderConePremiumSVG in worker/src/flavor-colors.js
// Grid: 24x28px. Scatter toppings with Mulberry32 PRNG + collision detection.
// Constants mirror the server-side arrays exactly.
var _PSR=[[3,18],[1,22],[0,23],[0,23],[0,23],[0,23],[0,23],[0,23],[1,22],[2,20],[3,18],[4,16],[5,15],[6,14]]; // scoop rows
var _PCR=[[5,19],[5,19],[6,18],[6,18],[7,17],[7,17],[8,16],[8,16],[9,15],[9,15],[10,14],[10,14],[11,13],[11,13]]; // cone rows
var _PRP=[[6,2],[8,4],[10,6],[12,8],[14,10],[12,11],[10,12]]; // ribbon path
var _PSHAPES={'default':[[0,0],[1,0],[0,1],[1,1]],'chunk':[[0,0],[1,0],[2,0],[0,1],[1,1],[2,1]],'sliver':[[0,0],[0,1],[0,2]]};
var _PSHMAP={pie_crust:'chunk',pecan:'chunk',pretzel:'chunk',heath:'sliver',chocolate_chip:'sliver'};
function premiumCone(name,s) {
  s=s||6;
  var p=getP(name), bc=colorData.base_colors||{}, tc=colorData.topping_colors||{}, rc=colorData.ribbon_colors||{}, cc=colorData.cone_colors||SEED_CONE;
  var b=(p&&bc[p.base])?bc[p.base]:bCol(name), rk=p?p.ribbon:null;
  var rCol=(rk&&p&&p.density!=='pure')?(rc[rk]||SEED_RIBBON[rk]||null):null;
  var den=p?p.density:'standard', tops=p?(p.toppings||[]):[];
  // resolvePremiumToppingList inline
  var tl;
  if(den==='pure') tl=[];
  else if(den==='double'){tl=tops.length?[tops[0],tops[0]]:[];if(tops.length>1)tl.push(tops[1]);}
  else if(den==='explosion'){tl=[];tops.forEach(function(t){tl.push(t);tl.push(t);});}
  else if(den==='overload'){tl=tops.length?[tops[0],tops[0],tops[0],tops[0],tops[0],tops[0]]:[];}
  else{tl=tops.slice();}
  // Deterministic seed from flavor name
  var seed=name.split('').reduce(function(a,c){return((a*31+c.charCodeAt(0))|0);},0);
  var ms=seed>>>0;
  function rng(){ms=(ms+0x6D2B79F5)>>>0;var t=Math.imul(ms^(ms>>>15),ms|1);t^=t+Math.imul(t^(t>>>7),t|61);return((t^(t>>>14))>>>0)/4294967296;}
  function texH(col,row){var h=((col*2246822519)^(row*3266489917)^seed)>>>0,r=h%20;if(r===0)return lh(b,0.07);if(r===1)return dk(b,0.07);return b;}
  var hl=lh(b,0.22),sh=dk(b,0.10),o=[];
  // 1. Base scoop fill with texture
  _PSR.forEach(function(sr,row){for(var col=sr[0];col<=sr[1];col++)o.push(R(col*s,row*s,s,s,texH(col,row)));});
  // 2. Highlight cap: rows 0-1 cols 4-7, rows 2-3 cols 3-5
  for(var hc=4;hc<=7;hc++){o.push(R(hc*s,0,s,s,hl));o.push(R(hc*s,1*s,s,s,hl));}
  for(var hc2=3;hc2<=5;hc2++){o.push(R(hc2*s,2*s,s,s,hl));o.push(R(hc2*s,3*s,s,s,hl));}
  // 3. Shadow rim: edges of rows 12-13
  [[5,12],[6,12],[14,12],[15,12],[6,13],[7,13],[13,13],[14,13]].forEach(function(pt){o.push(R(pt[0]*s,pt[1]*s,s,s,sh));});
  // 4. Ribbon
  if(rCol)_PRP.forEach(function(pt){o.push(R(pt[0]*s,pt[1]*s,3*s,2*s,rCol));});
  // 5. Scatter toppings
  var occ={},total=tl.length*2;
  for(var pi=0;pi<total;pi++){
    var tk=tl[pi%tl.length],col=tc[tk]||SEED_TOPPING[tk];
    if(!col)continue;
    var shape=_PSHAPES[_PSHMAP[tk]||'default'];
    for(var att=0;att<30;att++){
      var row=Math.floor(rng()*_PSR.length),sr=_PSR[row],ac=sr[0]+Math.floor(rng()*(sr[1]-sr[0]+1)),ok=true;
      for(var si=0;si<shape.length;si++){var pc=ac+shape[si][0],pr=row+shape[si][1];if(pr>=_PSR.length){ok=false;break;}var psr=_PSR[pr];if(pc<psr[0]||pc>psr[1]){ok=false;break;}if(occ[pr*100+pc]){ok=false;break;}}
      if(ok){for(var si2=0;si2<shape.length;si2++){var pc2=ac+shape[si2][0],pr2=row+shape[si2][1];occ[pr2*100+pc2]=1;o.push(R(pc2*s,pr2*s,s,s,col));}break;}
    }
  }
  // 6. Cone rows 14-27
  _PCR.forEach(function(cr,ri){var absRow=ri+14;for(var c=cr[0];c<=cr[1];c++){var wc=((absRow+c)%2===0)?cc.waffle:cc.waffle_dark;o.push(R(c*s,absRow*s,s,s,wc));}});
  // 7. Tip
  o.push(R(11*s,27*s,3*s,s,CONE_TIP));
  return '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 '+(24*s)+' '+(28*s)+'" width="'+(24*s)+'" height="'+(28*s)+'" shape-rendering="crispEdges">'+o.join('')+'</svg>';
}

// Render HD cone using LEGACY_PROFILES (before-state for comparison column)
function hdLegacy(name, s) {
  var saved = colorData.profiles;
  colorData.profiles = LEGACY_PROFILES;
  var svg = hdCone(name, s);
  colorData.profiles = saved;
  return svg;
}

// Profile equality check for "changed" badge
function profileChanged(name) {
  var k = nfk(name);
  var cur = (colorData.profiles||{})[k];
  var leg = LEGACY_PROFILES[k];
  if (!cur && !leg) return false;
  if (!cur || !leg) return true;
  return cur.base !== leg.base || cur.ribbon !== leg.ribbon || cur.density !== leg.density ||
    JSON.stringify(cur.toppings) !== JSON.stringify(leg.toppings);
}

// ---------------------------------------------------------------------------
// Build collision section
// ---------------------------------------------------------------------------
function buildCollisions() {
  function renderPair(col) {
    var side=function(s){ return '<div class="col-side"><div class="cname">'+s.name+'</div>'+(s.has_profile?'<span class="badge b-ok">profile</span>':'<span class="badge b-err">no profile</span>')+hdCone(s.name,3)+'<div class="cwhere">'+s.where+'</div></div>'; };
    var verdict=col.verdict?'<div style="font-size:11px;color:#9EC5E8;margin:8px 0 4px;line-height:1.4;">'+col.verdict+'</div>':'';
    return '<div class="col-pair"><h3>'+col.label+'</h3>'+verdict+'<div class="col-sides">'+side(col.a)+side(col.b)+'</div></div>';
  }

  var active=COLLISIONS.filter(function(c){return !c.resolved;});
  var resolved=COLLISIONS.filter(function(c){return !!c.resolved;});

  var activeGrid=document.getElementById('col-grid-active');
  var noneMsg=document.getElementById('col-none');
  if(active.length) {
    activeGrid.innerHTML=active.map(renderPair).join('');
    noneMsg.style.display='none';
  } else {
    activeGrid.innerHTML='';
    noneMsg.style.display='';
  }

  var resolvedGrid=document.getElementById('col-grid-resolved');
  var resolvedWrap=document.getElementById('col-resolved-wrap');
  var resolvedSummary=document.getElementById('col-resolved-summary');
  resolvedGrid.innerHTML=resolved.map(renderPair).join('');
  resolvedSummary.textContent='Resolved investigations ('+resolved.length+')';
  resolvedWrap.style.display=resolved.length?'':'none';
}

// ---------------------------------------------------------------------------
// Build flavor row
// ---------------------------------------------------------------------------
function profileTitle(id) {
  return id.split(' ').map(function(w){return w.charAt(0).toUpperCase()+w.slice(1);}).join(' ').replace(/\bOreo\b/g,'OREO');
}

// Quality flag analysis for a flavor
function qualityFlags(name) {
  var p=getP(name), tc=colorData.topping_colors||{}, flags=[];
  if(!p) return flags;
  var tops=p.toppings||[], den=p.density||'standard';
  // Sparse: explosion/overload density but few toppings
  if((den==='explosion'||den==='overload') && tops.length < 3)
    flags.push({cls:'qf-warn', label:'sparse toppings ('+den+' but '+tops.length+' defined)'});
  // Unknown topping color
  tops.forEach(function(k){ if(!(tc[k]||SEED_TOPPING[k])) flags.push({cls:'qf-err', label:'unknown topping color: '+k}); });
  // Long name (Tidbyt abbreviation needed)
  if(name.length > 24) flags.push({cls:'qf-info', label:'long name ('+name.length+' chars) — Tidbyt will abbreviate'});
  // Pure with toppings defined
  if(den==='pure' && tops.length > 0) flags.push({cls:'qf-warn', label:'pure density but toppings listed (ignored in render)'});
  return flags;
}

function buildRow(flavor) {
  var name=flavor.title, desc=flavor.description||'', hasP=!!getP(name), profileOnly=!!flavor._profileOnly;
  var isHistorical=!!flavor.historical;
  var status, badge;
  if(hasP && !profileOnly)  { status='s-ok';   badge='<span class="badge b-ok">profile + catalog</span>'; }
  else if(!hasP)             { status='s-warn';  badge='<span class="badge b-err">no profile</span>'; }
  else                       { status='s-info';  badge='<span class="badge b-info">profile-only</span>'; }
  var histBadge=isHistorical?'<span class="badge" style="background:#2a1a3e;color:#c084fc;margin-left:4px">historical</span>':'';
  var flags=qualityFlags(name);

  var ac=bCol(name);

  // c1: name
  var c1='<div class="c c-name"><span class="ftitle">'+name+'</span>'+(desc?'<span class="fdesc">'+desc+'</span>':'')+badge+histBadge+'</div>';

  // c2: Tidbyt pixel view — mini cone at scale 1, CSS scaled ×6 with pixelated rendering
  var tdSvg=miniCone(name,1);
  // scale 1 SVG is 9×11px; zoom ×5 = 45×55px, fits in 58px column
  var c2='<div class="c"><div class="tidbyt-wrap"><div class="tidbyt-inner" style="transform:scale(5)">' + tdSvg + '</div></div></div>';

  // c3: widget mini ×5
  var c3='<div class="c">'+miniCone(name,5)+'</div>';

  // c4: map marker on dark and light backgrounds
  var mkrD='<div class="mp" style="border-color:'+ac+'">'+miniCone(name,4)+'</div>';
  var mkrL='<div class="mp" style="border-color:'+ac+';background:#e8edf5">'+miniCone(name,4)+'</div>';
  var c4='<div class="c"><div class="map-pair"><div class="map-bg-d">'+mkrD+'</div><div class="map-bg-l">'+mkrL+'</div></div></div>';

  // c5: HD ×5 (radar cards)
  var c5='<div class="c">'+hdCone(name,5)+'</div>';

  // c5b: Before HD ×8 (legacy profile snapshot for comparison)
  var changed=profileChanged(name);
  var legacySvg=LEGACY_PROFILES[nfk(name)]?hdLegacy(name,8):'<div style="color:var(--muted);font-size:10px;text-align:center">new</div>';
  var c5b='<div class="c c-before" style="padding:4px;">'+legacySvg+(changed?'<span class="badge b-changed">changed</span>':'')+'</div>';

  // c6: HD ×8 (hero/OG — documented scale for social cards)
  var c6='<div class="c" style="padding:4px;">'+hdCone(name,8)+'</div>';

  // c6b: Premium ×6 (24x28 scatter — round dome, texture hash, seeded toppings)
  var c6b='<div class="c" style="padding:4px;">'+premiumCone(name,6)+'</div>';

  // c7: quality flags + colors
  var c7;
  if(hasP) {
    var p=getP(name), bc=colorData.base_colors||{}, tc=colorData.topping_colors||{}, rc=colorData.ribbon_colors||{};
    var sw='';
    if(p&&bc[p.base]) sw+='<div class="swg"><div class="sw" style="background:'+bc[p.base]+'" title="base: '+p.base+'"></div><div class="swl">'+p.base+'</div></div>';
    var seen={};
    (p?p.toppings||[]:[] ).forEach(function(k){if(seen[k])return;seen[k]=1;var col=tc[k]||SEED_TOPPING[k];if(col)sw+='<div class="swg"><div class="sw" style="background:'+col+'" title="'+k+'"></div><div class="swl">'+k+'</div></div>';});
    if(p&&p.ribbon){var rcol=rc[p.ribbon]||SEED_RIBBON[p.ribbon];if(rcol)sw+='<div class="swg"><div class="sw" style="background:'+rcol+';border:2px dashed rgba(255,255,255,.3)" title="ribbon: '+p.ribbon+'"></div><div class="swl">'+p.ribbon+'</div></div>';}
    var den=p?p.density||'standard':'standard';
    var flagHtml=flags.map(function(f){return '<span class="qf '+f.cls+'">'+f.label+'</span>';}).join('');
    c7='<div class="c c-meta">'+(flagHtml?'<div class="qflags" style="margin-bottom:5px">'+flagHtml+'</div>':'')+'<div class="swr">'+sw+'</div><div class="mtags"><span class="mt d-'+den+'">'+den+'</span>'+(p&&p.ribbon?'<span class="mt">ribbon: '+p.ribbon+'</span>':'')+'</div></div>';
  } else {
    c7='<div class="c c-meta"><div class="noprof">No cone profile — rendering will use color fallback on all surfaces.</div></div>';
  }

  var row=document.createElement('div');
  row.className='frow '+status+(flags.length?' s-flagged':'');
  row.dataset.name=name.toLowerCase();
  row.dataset.status=status;
  row.dataset.flagged=flags.length?'1':'0';
  row.innerHTML=c1+c2+c3+c4+c5+c5b+c6+c6b+c7;
  return row;
}

// ---------------------------------------------------------------------------
// Filter
// ---------------------------------------------------------------------------
function applyFilters() {
  var q=document.getElementById('search').value.toLowerCase();
  var fok=document.getElementById('f-ok').checked;
  var fwarn=document.getElementById('f-warn').checked;
  var finfo=document.getElementById('f-info').checked;
  var fflag=document.getElementById('f-flagged').checked;
  var total=0,vis=0;
  document.querySelectorAll('.frow').forEach(function(row){
    total++;
    var match=(!q||row.dataset.name.includes(q));
    var st=row.dataset.status;   // e.g. "s-ok" or "s-warn"
    var isFlagged=row.dataset.flagged==='1';
    var typeOk=(st==='s-ok'&&fok)||(st==='s-warn'&&fwarn)||(st==='s-info'&&finfo);
    var flagOk=!isFlagged||(isFlagged&&fflag);
    row.style.display=(match&&typeOk&&flagOk)?'':'none';
    if(match&&typeOk&&flagOk) vis++;
  });
  document.getElementById('fcount').textContent=vis+' of '+total+' shown';
}
['search','f-ok','f-warn','f-info','f-flagged'].forEach(function(id){
  var el=document.getElementById(id);
  if(el) el.addEventListener(id==='search'?'input':'change',applyFilters);
});

// ---------------------------------------------------------------------------
// Build grid from merged catalog + profile list
// ---------------------------------------------------------------------------
function buildGrid(catalog) {
  var profiles=colorData.profiles||{};
  var seen={};
  var all=[];
  catalog.forEach(function(f){ seen[nfk(f.title)]=true; all.push(f); });
  Object.keys(profiles).forEach(function(id){ if(!seen[id]) all.push({title:profileTitle(id),description:'',_profileOnly:true}); });
  all.sort(function(a,b){return a.title.localeCompare(b.title);});

  var okC=0,warnC=0,infoC=0,flagC=0;
  all.forEach(function(f){ var hp=!!getP(f.title); if(hp&&!f._profileOnly) okC++; else if(!hp) warnC++; else infoC++; if(qualityFlags(f.title).length) flagC++; });

  document.getElementById('s-prof').textContent=Object.keys(profiles).length;
  document.getElementById('s-cat').textContent=catalog.length;
  document.getElementById('s-ok').textContent=okC;
  document.getElementById('s-warn').textContent=warnC;
  document.getElementById('s-info').textContent=infoC;
  document.getElementById('s-flagged').textContent=flagC;

  buildCollisions();

  var grid=document.getElementById('fgrid');
  grid.innerHTML='';
  all.forEach(function(f){ grid.appendChild(buildRow(f)); });
  applyFilters();
}

// ---------------------------------------------------------------------------
// Boot: render immediately from seed, then try live API upgrade
// ---------------------------------------------------------------------------
buildGrid(SEED_CATALOG);

var WORKER_BASE=(new URLSearchParams(location.search).get('worker')==='local')?'http://localhost:8788':((window.CustardPlanner&&window.CustardPlanner.WORKER_BASE)||'https://custard.chriskaschner.com');
var done=0;
var liveCatalog=null;

function tryLive() {
  if(++done<2) return;
  // If we got live data, rebuild
  var cat=liveCatalog||SEED_CATALOG;
  var note=document.getElementById('api-note');
  if(liveCatalog) {
    note.textContent='live data from API';
    note.style.color='var(--ok-t)';
  } else {
    note.textContent='API unavailable — showing seed data';
  }
  if(liveCatalog||colorData.profiles!==SEED_PROFILES) buildGrid(cat);
}

fetch(WORKER_BASE+'/api/v1/flavor-colors')
  .then(function(r){return r.ok?r.json():null;})
  .then(function(d){if(d&&d.profiles){colorData=d;} tryLive();})
  .catch(function(){tryLive();});

fetch(WORKER_BASE+'/api/v1/flavors/catalog')
  .then(function(r){return r.ok?r.json():null;})
  .then(function(d){
    if(d&&Array.isArray(d.flavors)) liveCatalog=d.flavors;
    else if(Array.isArray(d)) liveCatalog=d;
    tryLive();
  })
  .catch(function(){tryLive();});
</script>
</body>
</html>
