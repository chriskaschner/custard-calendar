<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Today's Flavors â€” Custard Calendar</title>
  <meta name="description" content="Today's flavor of the day at your selected stores.">
  <link rel="stylesheet" href="style.css">
  <style>
    .page-header {
      padding: 1.25rem 0 0.75rem;
      border-bottom: 1px solid var(--border);
      margin-bottom: 1.25rem;
    }
    .page-header h1 {
      font-size: 1.25rem;
      color: var(--brand);
    }
    .page-header p {
      color: var(--text-muted);
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }

    .store-cards {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .store-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .store-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 1rem;
      font-size: 0.8125rem;
      font-weight: 600;
      color: white;
      background: var(--brand);
    }
    .store-card-header .brand-label {
      font-weight: 400;
      opacity: 0.85;
      font-size: 0.75rem;
    }
    .store-card-header .store-city {
      font-size: 0.875rem;
      font-weight: 700;
    }

    .store-card-body {
      display: flex;
      align-items: center;
      gap: 0.875rem;
      padding: 0.875rem 1rem;
    }

    .store-cone {
      flex-shrink: 0;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .store-cone svg { display: block; }

    .store-flavor-info {
      flex: 1;
      min-width: 0;
    }
    .store-flavor-name {
      font-size: 1rem;
      font-weight: 700;
      line-height: 1.25;
      color: var(--text);
    }
    .store-flavor-desc {
      font-size: 0.8125rem;
      color: var(--text-muted);
      margin-top: 0.2rem;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .store-flavor-meta {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.4rem;
    }
    .store-rarity {
      font-size: 0.6875rem;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }
    .store-date {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .store-card-footer {
      border-top: 1px solid var(--border);
      padding: 0.5rem 1rem;
      display: flex;
      gap: 0.75rem;
    }
    .store-card-footer a {
      font-size: 0.8125rem;
      color: var(--brand);
      text-decoration: none;
      font-weight: 500;
    }
    .store-card-footer a:hover { text-decoration: underline; }

    /* Loading skeleton */
    .skeleton-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }
    .skeleton-bar {
      height: 36px;
      background: #e8ecef;
    }
    .skeleton-body {
      padding: 0.875rem 1rem;
      display: flex;
      gap: 0.875rem;
      align-items: center;
    }
    .skeleton-circle {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #e8ecef;
      flex-shrink: 0;
    }
    .skeleton-lines { flex: 1; }
    .skeleton-line {
      height: 12px;
      border-radius: 6px;
      background: #e8ecef;
      margin-bottom: 8px;
    }
    .skeleton-line.short { width: 40%; }
    .skeleton-line.long { width: 75%; }
    .skeleton-line.medium { width: 60%; }

    .error-card {
      background: white;
      border: 1px solid #fecaca;
      border-radius: var(--radius);
      padding: 1rem;
      color: #b91c1c;
      font-size: 0.875rem;
    }

    .no-stores-state {
      text-align: center;
      padding: 2rem 1rem;
      color: var(--text-muted);
    }
    .no-stores-state h2 {
      font-size: 1rem;
      color: var(--text);
      margin-bottom: 0.5rem;
    }
    .no-stores-state a {
      color: var(--brand);
      font-weight: 500;
    }

    .page-cta {
      margin-top: 1.5rem;
      padding: 1rem;
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      text-align: center;
      font-size: 0.875rem;
      color: var(--text-muted);
    }
    .page-cta a {
      color: var(--brand);
      font-weight: 500;
    }
  </style>
</head>
<body>
  <script src="planner-shared.js"></script>
  <script src="cone-renderer.js"></script>

  <div class="page-header">
    <h1>Today's Flavors</h1>
    <p id="page-subtitle">Loading...</p>
  </div>

  <main>
    <div id="loading-state" class="store-cards">
      <!-- Skeletons replaced by JS -->
    </div>
    <div id="cards-container" class="store-cards" hidden></div>
    <div id="no-stores-state" class="no-stores-state" hidden>
      <h2>No stores selected</h2>
      <p>Set up your widget stores at <a href="widget.html">widget setup</a>.</p>
    </div>
  </main>

  <div class="page-cta">
    Want daily flavor alerts? <a href="alerts.html">Set up alerts</a> or <a href="widget.html">configure your widget</a>.
  </div>

  <script>
    var WORKER_BASE = CustardPlanner.WORKER_BASE;
    var escapeHtml = CustardPlanner.escapeHtml;

    var BRAND_COLORS = CustardPlanner.BRAND_COLORS;

    var RARITY_COLORS = {
      'Ultra Rare': '#9C27B0',
      'Rare': '#E65100',
      'Uncommon': '#1565C0',
      'Common': '#757575',
      'Staple': '#2E7D32'
    };

    var loadingEl = document.getElementById('loading-state');
    var cardsEl = document.getElementById('cards-container');
    var noStoresEl = document.getElementById('no-stores-state');
    var subtitleEl = document.getElementById('page-subtitle');

    function slugsFromURL() {
      var params = new URLSearchParams(window.location.search);
      var raw = params.get('stores') || '';
      return raw.split(',').map(function(s) { return s.trim(); }).filter(Boolean).slice(0, 3);
    }

    function renderSkeleton() {
      var html = '';
      for (var i = 0; i < 3; i++) {
        html += '<div class="skeleton-card">' +
          '<div class="skeleton-bar"></div>' +
          '<div class="skeleton-body">' +
            '<div class="skeleton-circle"></div>' +
            '<div class="skeleton-lines">' +
              '<div class="skeleton-line short"></div>' +
              '<div class="skeleton-line long"></div>' +
              '<div class="skeleton-line medium"></div>' +
            '</div>' +
          '</div>' +
        '</div>';
      }
      loadingEl.innerHTML = html;
    }

    function brandStyle(brandName) {
      var c = BRAND_COLORS ? BRAND_COLORS[brandName] : null;
      if (c) return c;
      // Fallback for brands not in BRAND_COLORS
      return { bg: '#005696', text: '#FFFFFF' };
    }

    function cityFromName(storeName, fallback) {
      if (!storeName) return fallback || '';
      var m = storeName.match(/of\s+(.+?)(?:,|\s*-)/);
      if (m) return m[1].trim();
      var c = storeName.match(/^(.+?),/);
      if (c) return c[1].trim();
      return storeName;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      var d = new Date(dateStr + 'T12:00:00');
      var today = new Date();
      today.setHours(12, 0, 0, 0);
      if (d.toDateString() === today.toDateString()) return 'Today';
      var days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return days[d.getDay()] + ', ' + months[d.getMonth()] + ' ' + d.getDate();
    }

    function renderCard(data, slug) {
      var style = brandStyle(data ? data.brand : null);
      var city = data ? cityFromName(data.store, slug) : slug;
      var brandLabel = data && data.brand ? data.brand : '';
      var flavorName = data ? (data.flavor || 'Not yet posted') : 'Unavailable';
      var flavorDesc = data ? (data.description || '') : '';
      var dateLabel = data ? formatDate(data.date) : '';
      var rarity = data && data.rarity ? data.rarity : null;

      // Cone SVG (HD scale 4 = ~72px)
      var coneSvg = '';
      try {
        coneSvg = renderMiniConeHDSVG(data ? data.flavor : '', 4);
      } catch(e) {
        coneSvg = '';
      }

      var rarityHtml = '';
      if (rarity && rarity.label) {
        var rc = RARITY_COLORS[rarity.label] || '#757575';
        rarityHtml = '<span class="store-rarity" style="color:' + escapeHtml(rc) + '">' + escapeHtml(rarity.label) + '</span>';
      }

      var metaHtml = '';
      if (dateLabel || rarityHtml) {
        metaHtml = '<div class="store-flavor-meta">' + (dateLabel ? '<span class="store-date">' + escapeHtml(dateLabel) + '</span>' : '') + rarityHtml + '</div>';
      }

      var descHtml = flavorDesc
        ? '<div class="store-flavor-desc">' + escapeHtml(flavorDesc) + '</div>'
        : '';

      var footerHtml = '<div class="store-card-footer">' +
        '<a href="/?store=' + encodeURIComponent(slug) + '">Full forecast</a>' +
        '<a href="/radar.html?store=' + encodeURIComponent(slug) + '">Radar</a>' +
        '</div>';

      return '<div class="store-card">' +
        '<div class="store-card-header" style="background:' + escapeHtml(style.bg) + ';color:' + escapeHtml(style.text) + '">' +
          '<span class="store-city">' + escapeHtml(city) + '</span>' +
          '<span class="brand-label">' + escapeHtml(brandLabel) + '</span>' +
        '</div>' +
        '<div class="store-card-body">' +
          '<div class="store-cone" aria-hidden="true">' + coneSvg + '</div>' +
          '<div class="store-flavor-info">' +
            '<div class="store-flavor-name">' + escapeHtml(flavorName) + '</div>' +
            descHtml +
            metaHtml +
          '</div>' +
        '</div>' +
        footerHtml +
      '</div>';
    }

    function renderErrorCard(slug) {
      return '<div class="error-card">Could not load flavor data for <strong>' + escapeHtml(slug) + '</strong>.</div>';
    }

    async function fetchToday(slug) {
      var url = WORKER_BASE + '/api/v1/today?slug=' + encodeURIComponent(slug);
      var resp = await fetch(url);
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      return await resp.json();
    }

    async function init() {
      var slugs = slugsFromURL();

      if (slugs.length === 0) {
        loadingEl.hidden = true;
        noStoresEl.hidden = false;
        subtitleEl.textContent = 'No stores selected.';
        return;
      }

      subtitleEl.textContent = 'Fetching ' + slugs.length + ' store' + (slugs.length > 1 ? 's' : '') + '...';
      renderSkeleton();

      var results = await Promise.allSettled(slugs.map(function(s) { return fetchToday(s); }));

      var html = '';
      for (var i = 0; i < slugs.length; i++) {
        var r = results[i];
        if (r.status === 'fulfilled') {
          html += renderCard(r.value, slugs[i]);
        } else {
          html += renderErrorCard(slugs[i]);
        }
      }

      loadingEl.hidden = true;
      cardsEl.innerHTML = html;
      cardsEl.hidden = false;

      var today = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
      subtitleEl.textContent = today;
    }

    init();
  </script>
</body>
</html>
